<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
 
<mapper namespace="kr.co.hkcloud.palette3.statistics.phone.dao.StatisticsPhoneLMMapper">
	<select id="selectRtnLm" parameterType="java.util.HashMap" resultType="java.util.HashMap">
		SELECT AA.*
			, ROWNUM AS ROW_NUMBER
		FROM (
			SELECT A.CUSTCO_ID AS ASP_NEWCUST_KEY
				, (SELECT CO_NM FROM PLT_ASP_CUS WHERE CUSTCO_ID = A.CUSTCO_ID) AS ASP_CUST_NM
				, A.LM_ID
				, A.LM_EVA_ID
				, A.LM_ID_NM
				, A.LM_TY
				, (SELECT CD_NM FROM PLT_COMN_CD WHERE GROUP_CD = 'PLT018' AND CD = A.LM_TY) AS LM_TY_NM
				, TO_CHAR(TO_DATE(A.LM_ST_DTTM, 'YYYYMMDDHH24MISS'), 'YYYY-MM-DD HH24:MI') AS LM_ST_DTTM
				, TO_CHAR(TO_DATE(A.LM_ST_DTTM, 'YYYYMMDDHH24MISS'), 'YYYY-MM-DD') AS LM_ST_DATE
				, TO_CHAR(TO_DATE(A.LM_ST_DTTM, 'YYYYMMDDHH24MISS'), 'HH24:MI') AS LM_ST_TIME
				, TO_CHAR(TO_DATE(A.LM_EN_DTTM, 'YYYYMMDDHH24MISS'), 'YYYY-MM-DD HH24:MI') AS LM_EN_DTTM
				, TO_CHAR(TO_DATE(A.LM_EN_DTTM, 'YYYYMMDDHH24MISS'), 'YYYY-MM-DD') AS LM_EN_DATE
				, TO_CHAR(TO_DATE(A.LM_EN_DTTM, 'YYYYMMDDHH24MISS'), 'HH24:MI') AS LM_EN_TIME
				, A.LM_TG_SC
				, A.LM_PG_ST
				, COALESCE((SELECT CD_NM FROM PLT_COMN_CD WHERE GROUP_CD = 'PLT023' AND CD = A.LM_PG_ST), '-') AS LM_PG_ST_NM
				, COALESCE(A.LM_LIM_TIME, '-') AS LM_LIM_TIME
				, A.LM_ATRT_GROUP_ID
				, A.LM_ATRT_GROUP_NM
				, A.USER_ATTR_A
				, A.USER_ATTR_B
				, A.USER_ATTR_C
				, A.USER_ATTR_D
				, A.LM_TG_CNT
				, A.LM_TG_PL_ID
				, A.LM_TG_PL_NM
				, DECODE(A.LM_PG_ST, 10, 'Y', 'N') AS MODIFY_YN
				, (SELECT COUNT(1) FROM PLT_LM_DATA WHERE CUSTCO_ID = A.CUSTCO_ID AND LM_ID = A.LM_ID) AS LM_DATA_COUNT
				, (SELECT COUNT(1) FROM PLT_LM_EVA_RST WHERE CUSTCO_ID = A.CUSTCO_ID AND LM_EVA_ID = A.LM_EVA_ID) AS LM_EVA_RST_COUNT
				, COALESCE((
			        	SELECT SUM(LM_QS_TY_SC)
			        	FROM PLT_LM_EVA_RST B, PLT_LM_QS C
			        	WHERE B.LM_QS_ID = C.LM_QS_ID
			        	AND B.CUSTCO_ID = C.CUSTCO_ID
			        	AND B.CUSTCO_ID = A.CUSTCO_ID
			        	AND B.LM_EVA_ID = A.LM_EVA_ID
			     ), 0) AS LM_EVA_SUM
			     , (SELECT COUNT(1) FROM PLT_LM_DATA WHERE CUSTCO_ID = A.CUSTCO_ID AND LM_ID = A.LM_ID AND LM_DATA_ANS_YN = 'N') AS LM_NON_DONE_CNT
			     , (SELECT COUNT(1) FROM PLT_LM_DATA WHERE CUSTCO_ID = A.CUSTCO_ID AND LM_ID = A.LM_ID AND LM_DATA_ANS_YN = 'Y') AS LM_DONE_CNT
			FROM PLT_LM A
			WHERE A.CUSTCO_ID = #{ASP_NEWCUST_KEY}
			<if test='LM_TY != null and LM_TY != ""'>
				AND A.LM_TY = #{LM_TY}
			</if>
			<if test='LM_ID_NM != null and LM_ID_NM != ""'>
				AND A.LM_ID_NM LIKE '%' || #{LM_ID_NM} || '%'
			</if>
			<if test="START_DATE	!= '' and START_DATE != null">   AND TO_DATE(A.LM_EN_DTTM, 'YYYYMMDDHH24MISS') >= TO_DATE(REPLACE(#{START_DATE},'-','')||'000000', 'YYYYMMDDHH24MISS')  </if>
			<if test="END_DATE 		!= '' and END_DATE != null">  <![CDATA[ AND TO_DATE(A.LM_ST_DTTM, 'YYYYMMDDHH24MISS') <= TO_DATE(REPLACE(#{END_DATE},'-','') ||'235959', 'YYYYMMDDHH24MISS') ]]>   </if>
			ORDER BY A.LM_ID DESC
		) AA
	</select>
	
	<select id="selectRtnLmDetail" parameterType="java.util.HashMap" resultType="java.util.HashMap">
		SELECT 
			A.LM_ID
			, A.LM_ID_NM
			, TO_CHAR(TO_DATE(A.LM_ST_DTTM, 'YYYYMMDDHH24MISS'), 'YYYY-MM-DD HH24:MI') AS LM_ST_DTTM
			, TO_CHAR(TO_DATE(A.LM_EN_DTTM, 'YYYYMMDDHH24MISS'), 'YYYY-MM-DD HH24:MI') AS LM_EN_DTTM
			, A.LM_TG_SC
			, (SELECT COUNT(1) FROM PLT_LM_DATA WHERE CUSTCO_ID = A.CUSTCO_ID AND LM_ID = A.LM_ID) AS LM_DATA_COUNT
			, (SELECT COUNT(1) FROM PLT_LM_DATA WHERE CUSTCO_ID = A.CUSTCO_ID AND LM_ID = A.LM_ID AND LM_DATA_ANS_YN = 'N') AS LM_NON_DONE_CNT
			, (SELECT COUNT(1) FROM PLT_LM_DATA WHERE CUSTCO_ID = A.CUSTCO_ID AND LM_ID = A.LM_ID AND LM_DATA_ANS_YN = 'Y') AS LM_DONE_CNT
			, B.AVG_RST_SUM
			, B.STD_RST_SUM
			, B.VARI_RST_SUM
			, C.TG_SC_CNT
		FROM PLT_LM A, (
			SELECT ROUND(AVG(AAAA.LM_DATA_RST_SUM),1) AS AVG_RST_SUM
				, ROUND(STDDEV(AAAA.LM_DATA_RST_SUM),2) AS STD_RST_SUM
        		, ROUND(VARIANCE(AAAA.LM_DATA_RST_SUM),2) AS VARI_RST_SUM
		      FROM (
		        SELECT AAA.LM_DATA_ID ,SUM(AAA.LM_DATA_RST_SUM) AS LM_DATA_RST_SUM
			      FROM(
			        SELECT AA.LM_DATA_ID, BB.LM_QS_ID, COALESCE(MAX(BB.LM_DATA_RST_SUM), 0) AS LM_DATA_RST_SUM
			        FROM PLT_LM_DATA AA, PLT_LM_DATA_RST BB
			        WHERE AA.LM_DATA_ID = BB.LM_DATA_ID 
			        AND AA.LM_ID = #{LM_ID}
			        AND AA.LM_GRADING_YN = 'Y'
			        AND BB.LM_DATA_RST_SUM IS NOT NULL
			        GROUP BY AA.LM_DATA_ID, BB.LM_QS_ID
			        ) AAA
	       GROUP BY AAA.LM_DATA_ID
	      ) AAAA
		) B,
		(
			SELECT COUNT(1) AS TG_SC_CNT
		      FROM(
		        SELECT AAA.LM_DATA_ID ,SUM(AAA.LM_DATA_RST_SUM) AS LM_DATA_RST_SUM
		        FROM(
		          SELECT AA.LM_DATA_ID, BB.LM_QS_ID, COALESCE(MAX(BB.LM_DATA_RST_SUM), 0) AS LM_DATA_RST_SUM
		          FROM PLT_LM_DATA AA, PLT_LM_DATA_RST BB
		          WHERE AA.LM_DATA_ID = BB.LM_DATA_ID 
		          AND AA.LM_ID = #{LM_ID}
		          AND AA.LM_GRADING_YN = 'Y'
		          AND BB.LM_DATA_RST_SUM IS NOT NULL
		          GROUP BY AA.LM_DATA_ID, BB.LM_QS_ID
		          ) AAA
		        GROUP BY AAA.LM_DATA_ID
		        HAVING SUM(AAA.LM_DATA_RST_SUM) >= (SELECT LM_TG_SC FROM PLT_LM WHERE LM_ID = #{LM_ID})
		      ) AAAA
		) C
		WHERE A.LM_ID = #{LM_ID}
	</select>
	<select id="selectRtnLmDataRst" parameterType="java.util.HashMap" resultType="java.util.HashMap">
		SELECT A.CUSTCO_ID
		  , (SELECT CO_NM FROM PLT_ASP_CUS WHERE CUSTCO_ID = #{ASP_NEWCUST_KEY}) AS ASP_CUST_NM
		  , A.LM_DATA_ID
		  , (SELECT LISTAGG(COALESCE(SUBSTR(BB.ATRT_GROUP_NM, 1), '권한미할당'),',') WITHIN GROUP (ORDER BY BB.ATRT_GROUP_NM) AS ATRT_GROUP_NM
		      FROM PLT_USER_AUTH AA 
		      LEFT OUTER JOIN (SELECT ATRT_GROUP_ID
		                            , ATRT_GROUP_NM 
		                         FROM PLT_AUTH
		                       ) BB 
		                   ON AA.ATRT_GROUP_ID = BB.ATRT_GROUP_ID 
		      WHERE AA.USER_ID = A.LM_DATA_US_ID ) AS ATRT_GROUP_NM
		  , D.LM_TY
		  , (SELECT CD_NM FROM PLT_COMN_CD WHERE CD = D.LM_TY AND GROUP_CD = 'PLT018') AS LM_TY_NM
		  , A.LM_DATA_US_ID
		  , A.LM_DATA_US_NM
		  , TO_CHAR(TO_DATE(C.ENTCO_DT, 'YYYYMMDD'),'YYYY-MM-DD') AS ENTCO_DT
		  , B.LM_DATA_RST_SUM
		  , RANK() OVER (ORDER BY B.LM_DATA_RST_SUM DESC) AS LM_RANK
		FROM PLT_LM_DATA A, 
		(
		  SELECT AAA.LM_DATA_ID ,SUM(AAA.LM_DATA_RST_SUM) AS LM_DATA_RST_SUM
		  FROM(
		    SELECT AA.LM_DATA_ID, BB.LM_QS_ID, COALESCE(MAX(BB.LM_DATA_RST_SUM), 0) AS LM_DATA_RST_SUM
		    FROM PLT_LM_DATA AA, PLT_LM_DATA_RST BB
		    WHERE AA.LM_DATA_ID = BB.LM_DATA_ID 
		    AND AA.LM_ID = #{LM_ID}
		    AND AA.LM_GRADING_YN = 'Y'
		    AND BB.LM_DATA_RST_SUM IS NOT NULL
		    GROUP BY AA.LM_DATA_ID, BB.LM_QS_ID
		  ) AAA
		  GROUP BY AAA.LM_DATA_ID
		) B
		, PLT_USER C
		, PLT_LM D
		WHERE A.LM_DATA_ID = B.LM_DATA_ID
		AND A.LM_ID = D.LM_ID
		AND A.LM_DATA_US_ID = C.USER_ID
		AND A.LM_ID = #{LM_ID}
		AND A.LM_GRADING_YN = 'Y'
		AND A.CUSTCO_ID = #{ASP_NEWCUST_KEY}
	</select>
	
	<select id="selectRtnLmQs" parameterType="java.util.HashMap" resultType="java.util.HashMap">
		SELECT A.LM_EVA_ID
		  , A.LM_QS_ID
		  , B.LM_ID
		  , C.LM_QS_ID
		  , C.LM_QS_NM
		  , C.LM_QS_TY
		  , C.LM_QS_DIC
		  , (SELECT CD_NM FROM PLT_COMN_CD WHERE GROUP_CD = 'PLT020' AND CD = C.LM_QS_DIC) AS LM_QS_DIC_NM
		  , C.LM_QS_TY_SC
		  , (SELECT COUNT(1) FROM PLT_LM_DATA WHERE LM_ID = B.LM_ID AND LM_DATA_ANS_YN = 'Y') AS LM_ANS_COUNT
		  , (
		    SELECT COUNT(1)
		    FROM(
		      SELECT AA.LM_DATA_ID
		      FROM PLT_LM_DATA_RST AA, PLT_LM_DATA BB
		      WHERE AA.LM_DATA_ID = BB.LM_DATA_ID
		      AND BB.LM_ID = B.LM_ID
		      AND AA.LM_QS_ID = A.LM_QS_ID
		      AND BB.LM_DATA_ANS_YN = 'Y'
		      GROUP BY AA.LM_DATA_ID
		    ) 
		  ) AS QS_ANS_COUNT
		  , (
		    SELECT COUNT(1)
		    FROM(
		      SELECT AA.LM_DATA_ID
		      FROM PLT_LM_DATA_RST AA, PLT_LM_DATA BB
		      WHERE AA.LM_DATA_ID = BB.LM_DATA_ID
		      AND BB.LM_ID = B.LM_ID
		      AND AA.LM_QS_ID = A.LM_QS_ID
		      AND BB.LM_DATA_ANS_YN = 'Y'
		      AND BB.LM_GRADING_YN = 'Y'
		      <![CDATA[
			      AND AA.LM_DATA_RST_SUM > 0
		      ]]>
		      GROUP BY AA.LM_DATA_ID
		    ) 
		  ) AS QS_CORRECT_COUNT
		FROM PLT_LM_EVA_RST A, PLT_LM B, PLT_LM_QS C
		WHERE A.LM_EVA_ID = B.LM_EVA_ID
		AND A.LM_QS_ID = C.LM_QS_ID
		AND B.LM_ID = #{LM_ID}
		ORDER BY CAST(LM_EVA_RST_OD AS INTEGER)
	</select>
	
	<select id="selectRtnLmVe" parameterType="java.util.HashMap" resultType="java.util.HashMap">
		SELECT A.LM_QS_ID
		  , A.LM_QS_VE_ID
		  , A.LM_QS_VE_RT
		  , D.LM_QS_TY
		  , DECODE(B.LM_QS_VE_ID, NULL, 'N','Y') AS ANS_YN
		  , dense_rank() over (PARTITION BY A.LM_QS_ID order by A.LM_QS_VE_ID) AS VE_NUMBER
		  , COALESCE(C.ANS_CNT, 0) AS ANS_CNT
		  , COALESCE(C.NON_ZERO_CNT, 0) AS NON_ZERO_CNT
		FROM PLT_LM_VE A
		LEFT OUTER JOIN PLT_LM_QS_ANS B ON A.LM_QS_ID = B.LM_QS_ID AND A.LM_QS_VE_ID = B.LM_QS_VE_ID
		LEFT OUTER JOIN (
		  SELECT A.LM_QS_ID
		    , A.LM_QS_VE_ID
		    , COUNT(1) AS ANS_CNT 
		    , SUM(CASE WHEN A.LM_DATA_RST_SUM > 0 THEN 1 ELSE 0 END) AS NON_ZERO_CNT
		  FROM PLT_LM_DATA_RST A, PLT_LM_DATA B
		  WHERE A.LM_DATA_ID = B.LM_DATA_ID
		  AND B.LM_ID = #{LM_ID}
		  AND B.LM_DATA_ANS_YN = 'Y'
		  GROUP BY A.LM_QS_ID, A.LM_QS_VE_ID
		) C ON A.LM_QS_ID = C.LM_QS_ID AND A.LM_QS_VE_ID = C.LM_QS_VE_ID
		JOIN PLT_LM_QS D ON A.LM_QS_ID = D.LM_QS_ID
		WHERE A.LM_QS_ID IN (
		  SELECT LM_QS_ID
		  FROM PLT_LM_EVA_RST AA, PLT_LM BB
		  WHERE AA.LM_EVA_ID = BB.LM_EVA_ID
		  AND BB.LM_ID = #{LM_ID}
		)
		ORDER BY A.LM_QS_ID, A.LM_QS_VE_ID
	</select>
</mapper>