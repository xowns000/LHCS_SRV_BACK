<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
 
<mapper namespace="kr.co.hkcloud.palette3.phone.qa2.dao.PhoneQAExecutManageMapper">
	<select id="selectRtnExecutList" parameterType="java.util.HashMap" resultType="java.util.HashMap">
		SELECT AA.*
			, ROWNUM AS ROW_NUMBER
		FROM(
			SELECT A.QA_DATA_ID
				, MAX(B.QA_ID) AS QA_ID
				, MAX(B.QA_NM) AS QA_NM
				, MAX((SELECT CD_NM FROM PLT_COMN_CD WHERE GROUP_CD = 'PLT008' AND CD = B.QA_TY)) AS QA_TY_NM
				, MAX(B.QA_TA_ST) AS QA_TA_ST
				, MAX(B.QA_TA_DV) AS QA_TA_DV
				, MAX(B.QA_TG_TY) AS QA_TG_TY
				, MAX((SELECT CD_NM FROM PLT_COMN_CD WHERE GROUP_CD = 'PLT014' AND CD = B.QA_TA_DV)) AS QA_TA_DV_NM
				, MAX(B.QA_FS_CP_YN) AS QA_FS_CP_YN
		  		, MAX(B.QA_SC_CP_YN) AS QA_SC_CP_YN
				, MAX(D.QA_EVA_NM) AS QA_EVA_NM
				, MAX(D.QA_EVA_ID) AS QA_EVA_ID
				, MAX(D.QA_EVA_SUM) AS QA_EVA_SUM
				, MAX(D.QA_EVA_CN) AS QA_EVA_CN
				, MAX(TO_CHAR(TO_DATE(B.QA_ST_DTTM, 'YYYYMMDDHH24MISS'),'YYYY-MM-DD')) AS QA_ST_DTTM
				, MAX(TO_CHAR(TO_DATE(B.QA_EN_DTTM, 'YYYYMMDDHH24MISS'),'YYYY-MM-DD')) AS QA_EN_DTTM
				, COALESCE(MAX(C.QA_DATA_RST_CN),'0') AS QA_DATA_RST_CN
				, MAX(DECODE(C.QA_DATA_RST_CN, 1, 'Y','N')) AS FS_RST_SAVE_YN
				, MAX(DECODE(C.QA_DATA_RST_CN, 2, 'Y','N')) AS SC_RST_SAVE_YN
				, MAX(DECODE(C.QA_DATA_RST_CN, 3, 'Y','N')) AS FN_RST_SAVE_YN
				, SUM(DECODE(C.QA_DATA_RST_CN, 1, C.QA_DATA_RST_SUM, 0)) AS FS_RST_SUM
				, SUM(DECODE(C.QA_DATA_RST_CN, 2, C.QA_DATA_RST_SUM, 0)) AS SC_RST_SUM
				, SUM(DECODE(C.QA_DATA_RST_CN, 3, C.QA_DATA_RST_SUM, 0)) AS FN_RST_SUM
				, MAX(A.QA_DATA_US_NM) AS QA_DATA_US_NM
				, MAX(TO_CHAR(TRUNC(NOW()) + NUMTODSINTERVAL(A.QA_DATA_CNSL_TIME, 'second'), 'hh24:mi:ss')) AS CNSL_TIME
				, MAX(A.QA_DATA_CNSL_TIME) AS QA_DATA_CNSL_TIME
				, MAX((SELECT CNSL_TYP_NM FROM PLT_CHT_CUTT_TYP WHERE CNSL_TYP_CD = A.QA_CNSL_TYP_CD AND CUSTCO_ID = A.CUSTCO_ID)) AS QA_CNSL_TYP_CD_NM
				, MAX((SELECT CNSL_TYP_NM FROM PLT_CHT_CUTT_TYP WHERE CNSL_TYP_CD = A.QA_CNSL_TYP_CD_2 AND CUSTCO_ID = A.CUSTCO_ID)) AS QA_CNSL_TYP_CD_NM_2
				, MAX((SELECT CNSL_TYP_NM FROM PLT_CHT_CUTT_TYP WHERE CNSL_TYP_CD = A.QA_CNSL_TYP_CD_3 AND CUSTCO_ID = A.CUSTCO_ID)) AS QA_CNSL_TYP_CD_NM_3
				, MAX((SELECT CNSL_TYP_NM FROM PLT_CHT_CUTT_TYP WHERE CNSL_TYP_CD = A.QA_CNSL_TYP_CD_4 AND CUSTCO_ID = A.CUSTCO_ID)) AS QA_CNSL_TYP_CD_NM_4
				, MAX(A.TALK_CONTACT_ID) AS TALK_CONTACT_ID
				, MAX(A.CNSL_HIST_NO) AS CNSL_HIST_NO
				, MAX(A.RDWT_FILE_NM) AS RDWT_FILE_NM
				, MAX(A.CUSTCO_ID) AS ASP_NEWCUST_KEY
			FROM PLT_QA_DATA A
			JOIN PLT_QA B ON A.QA_ID = B.QA_ID
			JOIN PLT_QA_EVA D ON A.QA_EVA_ID = D.QA_EVA_ID 
			LEFT OUTER JOIN PLT_QA_DATA_RST C ON A.QA_DATA_ID = C.QA_DATA_ID
			WHERE 1=1
			<if test='QA_MANAGE_YN == "Y"'>
				AND A.QA_DATA_QAID = #{LOGIN_ID}
			</if>
			<if test='QA_MANAGE_YN == "N"'>
				<if test='ADMIN_YN != "Y"'>
					AND A.QA_DATA_US_ID = #{LOGIN_ID}				
				</if>
			</if>			
			
			<if test='ASP_NEWCUST_KEY != null and ASP_NEWCUST_KEY != ""'>
				AND A.CUSTCO_ID = #{ASP_NEWCUST_KEY}
			</if>
			<if test='QA_TY != null and QA_TY != ""'>
				AND B.QA_TY = #{QA_TY}
			</if>
			<if test='QA_NM != null and QA_NM != ""'>
				AND B.QA_NM LIKE '%' || #{QA_NM} || '%'
			</if>
			<if test='QA_EVA_NM != null and QA_EVA_NM != ""'>
				AND D.QA_EVA_NM LIKE '%' || #{QA_EVA_NM} || '%'
			</if>
			GROUP BY A.QA_DATA_ID
			ORDER BY A.QA_DATA_ID
		) AA
	</select>
	
	<select id="selectRtnQaManageYn" parameterType="java.util.HashMap" resultType="java.util.HashMap">
		SELECT CASE WHEN COUNT(1) > 0 THEN 'Y' ELSE 'N' END AS QA_MANAGE_YN
		FROM PLT_QA_US_RATER
		WHERE USER_ID = #{LOGIN_ID}
		AND CUSTCO_ID = #{ASP_NEWCUST_KEY}
	</select>
	
	<select id="selectRtnAdminYn" parameterType="java.util.HashMap" resultType="java.util.HashMap">
		SELECT CASE WHEN COUNT(1) > 0 THEN 'Y' ELSE 'N' END AS ADMIN_YN
		FROM PLT_USER_AUTH
		WHERE USER_ID = #{LOGIN_ID}
		AND ATRT_GROUP_ID IN (
			'20190125141939798TWB52868'
			,'20210531110819073TWB424557'
		) 
	</select>
	
	<select id="selectRtnQaDataRst" parameterType="java.util.HashMap" resultType="java.util.HashMap">
		SELECT A.QA_ID
		  , A.QA_EVA_ID
		  , A.QA_DATA_ID
		  , A.QA_DATA_TY
		  , B.QA_QS_ID
		  , DENSE_RANK() OVER(ORDER BY CAST(B.QA_EVA_RST_OD AS INTEGER)) AS QA_QS_INDEX
		  , (SELECT COUNT(1) FROM PLT_QA_EVA_RST WHERE QA_EVA_ID = A.QA_EVA_ID) AS QA_QS_COUNT
		  , C.QA_QS_TY
		  , C.QA_QS_TY_SC
		  , C.QA_QS_NM
		  , D.QA_QS_VE_ID
		  , D.QA_QS_VE_SC
		  , D.QA_QS_VE_RT
		  ,(SELECT COUNT(1) FROM PLT_QA_VE WHERE QA_QS_ID = C.QA_QS_ID) AS VE_COUNT
		  , E.QA_NM
		  , E.QA_TY
		  , E.QA_TA_DV
		  , E.QA_TA_SC
		  , E.QA_TA_ST
		  , E.QA_TG_TY
		  , RST1.QA_DATA_RST_ID AS QA_DATA_RST_ID_1
		  , RST1.QA_QS_VE_ID AS QA_QS_VE_ID_1
		  , RST1.QA_QS_VE_RST_DATA AS QA_QS_VE_RST_DATA_1
		  , RST1.QA_DATA_RST_SUM AS QA_DATA_RST_SUM_1
		  , RST1.QA_DATA_RST_COM AS QA_DATA_RST_COM_1
		  , RST1.QA_DATA_RST_COM_RE AS QA_DATA_RST_COM_RE_1
		  , DECODE(RST1.QA_DATA_RST_COM_RE, NULL, 'N', 'Y') AS QA_DATA_RST_COM_RE_SAVE_YN_1
		  , RST2.QA_DATA_RST_ID AS QA_DATA_RST_ID_2
		  , RST2.QA_QS_VE_ID AS QA_QS_VE_ID_2
		  , RST2.QA_QS_VE_RST_DATA AS QA_QS_VE_RST_DATA_2
		  , RST2.QA_DATA_RST_SUM AS QA_DATA_RST_SUM_2
		  , RST2.QA_DATA_RST_COM AS QA_DATA_RST_COM_2
		  , RST2.QA_DATA_RST_COM_RE AS QA_DATA_RST_COM_RE_2
		  , DECODE(RST2.QA_DATA_RST_COM_RE, NULL, 'N', 'Y') AS QA_DATA_RST_COM_RE_SAVE_YN_2
		  , RST3.QA_DATA_RST_ID AS QA_DATA_RST_ID_3
		  , RST3.QA_QS_VE_ID AS QA_QS_VE_ID_3
		  , RST3.QA_QS_VE_RST_DATA AS QA_QS_VE_RST_DATA_3
		  , RST3.QA_DATA_RST_SUM AS QA_DATA_RST_SUM_3
		  , RST3.QA_DATA_RST_COM AS QA_DATA_RST_COM_3
		  , RST3.QA_DATA_RST_COM_RE AS QA_DATA_RST_COM_RE_3
		  , DECODE(RST3.QA_DATA_RST_COM_RE, NULL, 'N', 'Y') AS QA_DATA_RST_COM_RE_SAVE_YN_3
		  , CASE WHEN RST1.QA_DATA_RST_TCOM IS NOT NULL THEN RST1.QA_DATA_RST_TCOM
		  	WHEN RST2.QA_DATA_RST_TCOM IS NOT NULL THEN RST2.QA_DATA_RST_TCOM
		  	WHEN RST3.QA_DATA_RST_TCOM IS NOT NULL THEN RST3.QA_DATA_RST_TCOM
		  	END AS QA_DATA_RST_TCOM
		FROM PLT_QA_DATA A
		JOIN PLT_QA_EVA_RST B ON A.QA_EVA_ID = B.QA_EVA_ID
		JOIN PLT_QA_QS C ON B.QA_QS_ID = C.QA_QS_ID
		JOIN PLT_QA_VE D ON C.QA_QS_ID = D.QA_QS_ID
		JOIN PLT_QA E ON A.QA_ID = E.QA_ID
		LEFT OUTER JOIN PLT_QA_DATA_RST RST1 ON D.QA_QS_VE_ID = RST1.QA_QS_VE_ID AND A.QA_DATA_ID = RST1.QA_DATA_ID AND RST1.QA_DATA_RST_CN = 1
		LEFT OUTER JOIN PLT_QA_DATA_RST RST2 ON D.QA_QS_VE_ID = RST2.QA_QS_VE_ID AND A.QA_DATA_ID = RST2.QA_DATA_ID AND RST2.QA_DATA_RST_CN = 2
		LEFT OUTER JOIN PLT_QA_DATA_RST RST3 ON D.QA_QS_VE_ID = RST3.QA_QS_VE_ID AND A.QA_DATA_ID = RST3.QA_DATA_ID AND RST3.QA_DATA_RST_CN = 3
		WHERE A.CUSTCO_ID = #{ASP_NEWCUST_KEY}
		AND A.QA_DATA_ID = #{QA_DATA_ID}
		ORDER BY CAST(B.QA_EVA_RST_OD AS INTEGER), CAST(D.QA_QS_VE_OD AS INTEGER)
	</select>
	
	<insert id="processRtnQaDataRst" parameterType="java.util.HashMap">
		MERGE INTO PLT_QA_DATA_RST
		USING DUAL ON (
			QA_DATA_RST_ID = #{QA_DATA_RST_ID}
		)
		WHEN MATCHED THEN
		UPDATE SET
			CHNG_DTTM = TO_CHAR(NOW() ,'YYYYMMDDHH24MISS')
			, CHNG_ID = #{LOGIN_ID} 
			<if test='QA_DATA_RST_COM_RE != null and QA_DATA_RST_COM_RE != ""'>
			, QA_DATA_RST_COM_RE = #{QA_DATA_RST_COM_RE}			
			</if>
			<if test='QA_DATA_RST_TCOM != null and QA_DATA_RST_TCOM != ""'>
			, QA_DATA_RST_TCOM = #{QA_DATA_RST_TCOM}			
			</if>
		WHEN NOT MATCHED THEN
		INSERT (
			CUSTCO_ID
			, QA_DATA_RST_ID
			, QA_DATA_ID
			, QA_QS_VE_ID
			, QA_QS_VE_RST_DATA
			, QA_DATA_RST_CN
			, QA_DATA_RST_SUM
			, QA_DATA_RST_COM
			, QA_DATA_RST_TCOM
			, REG_DTTM
			, REG_ID
			, CHNG_DTTM
			, CHNG_ID
		) VALUES (
			#{ASP_NEWCUST_KEY}
			, #{QA_DATA_RST_ID}
			, #{QA_DATA_ID}
			, #{QA_QS_VE_ID}
			, (SELECT QA_QS_VE_RT FROM PLT_QA_VE WHERE QA_QS_VE_ID = #{QA_QS_VE_ID})
			, #{QA_DATA_RST_CN}
			, #{QA_DATA_RST_SUM}
			, #{QA_DATA_RST_COM}
			, #{QA_DATA_RST_TCOM}
			, TO_CHAR(NOW() ,'YYYYMMDDHH24MISS')
			, #{LOGIN_ID}
			, TO_CHAR(NOW() ,'YYYYMMDDHH24MISS')
			, #{LOGIN_ID}
		)
	</insert>
	
	<update id="updateRtnTcom" parameterType="java.util.HashMap">
		UPDATE PLT_QA_DATA_RST
		SET QA_DATA_RST_TCOM = #{QA_DATA_RST_TCOM}
			, CHNG_DTTM = TO_CHAR(NOW() ,'YYYYMMDDHH24MISS')
			, CHNG_ID = #{REG_ID} 
		WHERE QA_DATA_ID = #{QA_DATA_ID}
		AND CUSTCO_ID = #{ASP_NEWCUST_KEY}
	</update>
</mapper>