<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
 
<mapper namespace="kr.co.hkcloud.palette3.phone.callback.dao.PhoneCallbackListMapper">
	
	<!-- 데이터 ResultMap -->	
	<resultMap id="selectHashMap" type="java.util.HashMap" >
		<!-- 전체 암복호화  -->
		<result property="SEND_MAN_NO" column="SEND_MAN_NO" javaType="java.lang.String" typeHandler="kr.co.hkcloud.palette3.core.security.crypto.DamoDecryptionCipherTypeHandler" />
		<result property="CLBK_TEL_NO" column="CLBK_TEL_NO" javaType="java.lang.String" typeHandler="kr.co.hkcloud.palette3.core.security.crypto.DamoDecryptionCipherTypeHandler" />
		<!-- 부분 암복호화  -->
		<result property="CUST_NO" column="CUST_NO" javaType="java.lang.String" typeHandler="kr.co.hkcloud.palette3.core.security.crypto.DamoPartialDecryptionCipherTypeHandler" />
	</resultMap>

	<select id="selectClbkInqList"  parameterType= "java.util.HashMap" resultType="java.util.HashMap" >
<!--	SELECT   /*  selectClbkInqList 콜백 조회  */-->
<!--                    ROW_NUMBER() OVER() AS ROW_NUMBER-->
<!--                    , PPCL.CLBK_ID											/* 콜백 ID */-->
<!--                    , PPCL.DRWI_DT											/* 인입일시 */-->
<!--                    , PC.CUST_PHN_NO AS SNDPTY_NO							/* 발신자번호 */-->
<!--                    , PC.CUST_NM											/* 고객이름 */-->
<!--                    , PPCL.CLBK_PHN_NO										/* 콜백전화번호 */-->
<!--                    , PPCL.ALTMNT_DT										/* 배분일시 */-->
<!--                    , PU.USER_NM as CUSL_NM									/* 상담직원 */-->
<!--                    , PU.USER_ID as CUSL_ID									/* 상담직원 ID */-->
<!--                    , (SELECT EXT_NO-->
<!--                    FROM PLT_PHN_IP_EXT-->
<!--                    WHERE CUSTCO_ID = PPCL.CUSTCO_ID-->
<!--                    AND USER_ID = PPCA.CUSL_ID ) AS EXT_NO				    /* 내선번호 */-->
<!--                    , COALESCE(CNT.RTRY_NOCS, 0) as	RTRY_NOCS				/* 시도횟수 */-->
<!--                    , CNT.CALL_OUT_DT										/* 콜백일시 */-->
<!--                    , CUTT.CUSL_RS_CD   	           							/* 처리결과 */-->
<!--					, CUTT.CAMP_RS_CD											/* 상담결과 */-->
<!--					, CUTT.CAMP_RS_NM-->
<!--					, CUTT.CUSL_RS_NM-->
<!--					, CUTT.CUTT_BGNG_DT										/* 상담 시작일자 */-->
<!--					, COALESCE(CUTT.CLBK_CNT, 0)	as	FORC_RTRY_NOCS		/* 강제생성건 시도건수 */-->
<!--                    FROM PLT_PHN_CLBK PPCL-->
<!--                    LEFT OUTER JOIN PLT_PHN_CLBK_ALTMNT PPCA ON PPCA.CLBK_ID = PPCL.CLBK_ID-->
<!--                    LEFT OUTER JOIN PLT_CUST PC ON PC.CUST_ID = PPCL.CUST_ID-->
<!--                    LEFT OUTER JOIN PLT_USER PU ON PU.USER_ID = PPCA.CUSL_ID-->
<!--                    LEFT OUTER JOIN (SELECT COUNT(PPDH.CLBK_ID) AS RTRY_NOCS-->
<!--                    						, PPDH.CLBK_ID-->
<!--                    						, MAX(PPDH.REG_DT) AS CALL_OUT_DT-->
<!--									FROM PLT_PHN_DSPTCH_HSTRY PPDH -->
<!--									INNER JOIN PLT_PHN_CLBK PPCL2 -->
<!--									ON PPDH.CLBK_ID = PPCL2.CLBK_ID -->
<!--									GROUP BY PPDH.CLBK_ID-->
<!--									) CNT ON CNT.CLBK_ID = PPCL.CLBK_ID-->
<!--                    LEFT OUTER JOIN (SELECT PPC2.PHN_CUTT_ID-->
<!--										, PPC2.CLBK_ID-->
<!--										, PEA.ATTR_ID AS CUSL_RS_ID-->
<!--										, PPCDE.ATTR_VL AS CUSL_RS_CD-->
<!--										, PPCDE2.ATTR_VL AS CAMP_RS_CD-->
<!--										, COMM.CD_NM as CUSL_RS_NM-->
<!--										, COMM2.CD_NM as CAMP_RS_NM-->
<!--										, PPC2.CUTT_BGNG_DT-->
<!--										, PPC2.CUTT_END_DT-->
<!--										, PPC5.CLBK_CNT-->
<!--									 FROM PLT_PHN_CLBK PPCL3-->
<!--									 	left outer join PLT_PHN_CUTT PPC2 on PPCL3.CLBK_ID = PPC2.CLBK_ID-->
<!--										LEFT OUTER JOIN PLT_PHN_CLBK_ALTMNT PPCA ON PPCA.CUSL_ID = PPC2.CUSL_ID AND PPCA.CLBK_ID = PPC2.CLBK_ID-->
<!--										LEFT OUTER JOIN PLT_EXPSN_ATTR PEA ON PEA.CUSTCO_ID = PPC2.CUSTCO_ID AND PEA.BSC_PVSN_ATTR_YN = 'N' AND PEA.SE = 'CONSEL' AND PEA.EXPSN_ATTR_COL_ID = 'CUSL_RS'-->
<!--										LEFT OUTER JOIN PLT_PHN_CUTT_DTL_EXPSN PPCDE ON PPCDE.PHN_CUTT_ID = PPC2.PHN_CUTT_ID AND PPCDE.ATTR_ID = PEA.ATTR_ID-->
<!--										LEFT OUTER JOIN PLT_EXPSN_ATTR PEA2 ON PEA2.CUSTCO_ID = PPC2.CUSTCO_ID AND PEA2.BSC_PVSN_ATTR_YN = 'N' AND PEA2.SE = 'CONSEL' AND PEA2.EXPSN_ATTR_COL_ID = 'CAMP_RS' /*처리결과*/-->
<!--										LEFT OUTER JOIN PLT_PHN_CUTT_DTL_EXPSN PPCDE2 ON PPCDE2.PHN_CUTT_ID = PPC2.PHN_CUTT_ID AND PPCDE2.ATTR_ID = PEA2.ATTR_ID-->
<!--										LEFT OUTER JOIN PLT_COMM_CD COMM ON COMM.CUSTCO_ID = #{CUSTCO_ID}::INT AND COMM.CD_ID = PPCDE.ATTR_VL AND COMM.GROUP_CD_ID = 'CUSL_RS' /*상담결과*/-->
<!--										LEFT OUTER JOIN PLT_COMM_CD COMM2 ON COMM2.CUSTCO_ID = #{CUSTCO_ID}::INT AND COMM2.CD_ID = PPCDE2.ATTR_VL AND COMM2.GROUP_CD_ID = 'CAMP_RS' /*캠페인 결과*/-->
<!--										LEFT OUTER JOIN (SELECT COUNT(CLBK_ID) AS CLBK_CNT, CLBK_ID-->
<!--															FROM PLT_PHN_CUTT PPC4-->
<!--															WHERE PPC4.FORC_CRT_YN = 'Y'-->
<!--															GROUP BY PPC4.CLBK_ID) PPC5 ON PPC2.CLBK_ID = PPC5.CLBK_ID-->
<!--										WHERE PPC2.CUSTCO_ID = #{CUSTCO_ID}::INTEGER -->
<!--										and (PPC2.CLBK_ID,PPC2.CUTT_END_DT)-->
<!--											in (select clbk_id,max(CUTT_END_DT::BIGINT)::TEXT as call_out_dt from PLT_PHN_CUTT PPC3 where PPC3.CLBK_ID = PPCL3.CLBK_ID GROUP BY CLBK_ID)-->
<!--										) CUTT ON CUTT.CLBK_ID = PPCL.CLBK_ID -->
<!--                    WHERE PPCL.CUSTCO_ID = #{CUSTCO_ID}::INTEGER-->
<!--                    AND PPCL.ALTMNT_YN = 'Y'-->
<!--            <if test="DRWI_DT_START    	!= '' and	DRWI_DT_START 	 != null"> -->
<!--            AND ( PPCL.DRWI_DT::BIGINT-->
<!--            BETWEEN #{DRWI_DT_START}::BIGINT-->
<!--            AND #{DRWI_DT_END}::BIGINT)-->
<!--            </if>-->
<!--            <if test='NOCS_TY == "up"'>-->
<!--            	<![CDATA[ -->
<!--            		AND COALESCE(cnt.rtry_nocs, 0) >= #{RTRY_NOCS}::INTEGER-->
<!--            	]]>-->
<!--            </if>-->
<!--            <if test='NOCS_TY == "down"'>-->
<!--            	<![CDATA[ -->
<!--            		AND COALESCE(cnt.rtry_nocs, 0) <= #{RTRY_NOCS}::INTEGER-->
<!--            	]]>-->
<!--            </if>-->
<!--            <if test="USER_NM    	!= '' and	USER_NM 	 != null"> AND PU.USER_NM LIKE '%'|| #{USER_NM} ||'%'</if>-->
<!--            <if test="LGN_ID    	!= '' and	LGN_ID   	 != null"> AND PU.LGN_ID LIKE '%'|| #{LGN_ID} ||'%'</if>-->
<!--            <if test="CUSL_RS_CD    != '' and	CUSL_RS_CD	 != null"> AND CUTT.CUSL_RS_CD = #{CUSL_RS_CD}		 </if>-->
<!--            <if test="CAMP_RS_CD   	!= '' and	CAMP_RS_CD   != null"> AND CUTT.CAMP_RS_CD = #{CAMP_RS_CD}</if>-->
<!--    		ORDER BY CUTT.CUSL_RS_CD, PPCL.DRWI_DT 	-->
		SELECT
			ROW_NUMBER() OVER() AS RNUM
			, A.*
		FROM (
				SELECT
					ROW_NUMBER() OVER(PARTITION BY PPC.DRWI_DT, PPCA.CLBK_ID, PPCA.CUSL_ID, PPC.CUST_ID ORDER BY PPC.DRWI_DT DESC, PPCA.CLBK_ID, PPCA.CUSL_ID, PPC.CUST_ID, CUTT.PHN_CUTT_ID DESC) AS ROW_NUMBER
					, PPC.CLBK_ID
					, PPC.DRWI_DT
					, (SELECT CUST_PHN_NO FROM PLT_CUST WHERE CUST_ID = PPC.CUST_ID) AS SNDPTY_NO
					, PPC.CLBK_PHN_NO
					, PPC.ALTMNT_DT
					, PPC.CUST_ID
					, (SELECT CUST_NM FROM PLT_CUST WHERE CUST_ID = PPC.CUST_ID) AS CUST_NM
					, PPCA.CUSL_ID
					, (SELECT LGN_ID FROM PLT_USER WHERE USER_ID = PPCA.CUSL_ID) AS LGN_ID
					, (SELECT USER_NM FROM PLT_USER WHERE USER_ID = PPCA.CUSL_ID) AS CUSL_NM
					, (SELECT EXT_NO FROM PLT_PHN_IP_EXT WHERE CUSTCO_ID = PPC.CUSTCO_ID AND USER_ID = PPCA.CUSL_ID) AS EXT_NO
					, (SELECT COUNT(CLBK_ID) FROM PLT_PHN_DSPTCH_HSTRY WHERE CLBK_ID = PPC.CLBK_ID) AS RTRY_NOCS
					, (SELECT MAX(REG_DT) FROM PLT_PHN_DSPTCH_HSTRY WHERE CLBK_ID = PPC.CLBK_ID) AS CALL_OUT_DT
					, COALESCE((
						SELECT PPCDE.ATTR_VL
						FROM PLT_PHN_CUTT_DTL_EXPSN PPCDE
						WHERE PPCDE.PHN_CUTT_ID = CUTT.PHN_CUTT_ID
						AND EXISTS (SELECT 1 FROM PLT_EXPSN_ATTR WHERE CUSTCO_ID = PPC.CUSTCO_ID AND ATTR_ID = PPCDE.ATTR_ID AND EXPSN_ATTR_COL_ID = 'CUSL_RS')
					), 'PROCESSING') AS CUSL_RS_CD
					, (
						SELECT (SELECT CD_NM FROM PLT_COMM_CD WHERE CUSTCO_ID = PPC.CUSTCO_ID AND CD_ID = PPCDE.ATTR_VL  AND GROUP_CD_ID = (SELECT GROUP_CD_ID FROM PLT_EXPSN_ATTR WHERE CUSTCO_ID = PPC.CUSTCO_ID AND ATTR_ID = PPCDE.ATTR_ID AND EXPSN_ATTR_COL_ID = 'CUSL_RS'))
						FROM PLT_PHN_CUTT_DTL_EXPSN PPCDE
						WHERE PPCDE.PHN_CUTT_ID = CUTT.PHN_CUTT_ID
						AND EXISTS (SELECT 1 FROM PLT_EXPSN_ATTR WHERE CUSTCO_ID = PPC.CUSTCO_ID AND ATTR_ID = PPCDE.ATTR_ID AND EXPSN_ATTR_COL_ID = 'CUSL_RS')
					) AS CUSL_RS_NM
					, (
						SELECT PPCDE.ATTR_VL
						FROM PLT_PHN_CUTT_DTL_EXPSN PPCDE
						WHERE PPCDE.PHN_CUTT_ID = CUTT.PHN_CUTT_ID
						AND EXISTS (SELECT 1 FROM PLT_EXPSN_ATTR WHERE CUSTCO_ID = PPC.CUSTCO_ID AND ATTR_ID = PPCDE.ATTR_ID AND EXPSN_ATTR_COL_ID = 'CAMP_RS')
					) AS CAMP_RS_CD
					, (
						SELECT (SELECT CD_NM FROM PLT_COMM_CD WHERE CUSTCO_ID = PPC.CUSTCO_ID AND CD_ID = PPCDE.ATTR_VL  AND GROUP_CD_ID = (SELECT GROUP_CD_ID FROM PLT_EXPSN_ATTR WHERE CUSTCO_ID = PPC.CUSTCO_ID AND ATTR_ID = PPCDE.ATTR_ID AND EXPSN_ATTR_COL_ID = 'CAMP_RS'))
						FROM PLT_PHN_CUTT_DTL_EXPSN PPCDE
						WHERE PPCDE.PHN_CUTT_ID = CUTT.PHN_CUTT_ID
						AND EXISTS (SELECT 1 FROM PLT_EXPSN_ATTR WHERE CUSTCO_ID = PPC.CUSTCO_ID AND ATTR_ID = PPCDE.ATTR_ID AND EXPSN_ATTR_COL_ID = 'CAMP_RS')
					) AS CAMP_RS_NM
					, CUTT.FORC_CRT_YN
					, CUTT.CUTT_BGNG_DT
					, CUTT.PHN_CUTT_ID
					, (SELECT COUNT(PHN_CUTT_ID) FROM PLT_PHN_CUTT WHERE PHN_CUTT_ID = CUTT.PHN_CUTT_ID AND FORC_CRT_YN = 'Y') AS FORC_RTRY_NOCS
				FROM PLT_PHN_CLBK_ALTMNT PPCA
				INNER JOIN PLT_PHN_CLBK PPC ON PPC.CLBK_ID = PPCA.CLBK_ID
				LEFT OUTER JOIN PLT_PHN_CUTT CUTT ON CUTT.CLBK_ID = PPC.CLBK_ID
				WHERE PPC.CUSTCO_ID = #{CUSTCO_ID}::INT
				AND PPC.ALTMNT_YN = 'Y'
				<if test='DRWI_DT_START != null and	DRWI_DT_START != ""'>
				AND PPC.DRWI_DT BETWEEN #{DRWI_DT_START} AND #{DRWI_DT_END}
				</if>
		) A
		WHERE A.ROW_NUMBER = 1
		<if test='NOCS_TY == "up"'> AND COALESCE(A.RTRY_NOCS, 0) >= #{RTRY_NOCS}::INT</if>
		<if test='NOCS_TY == "down"'> AND COALESCE(A.RTRY_NOCS, 0)<![CDATA[<=]]>#{RTRY_NOCS}::INT</if>
		<if test='USER_NM != null and USER_NM != ""'> AND A.CUSL_NM LIKE '%'|| #{USER_NM} ||'%'</if>
		<if test='LGN_ID != null and LGN_ID != ""'> AND A.LGN_ID LIKE '%'|| #{LGN_ID} ||'%'</if>
		<if test='CUSL_RS_CD != null and CUSL_RS_CD	 != ""'> AND A.CUSL_RS_CD = #{CUSL_RS_CD}</if>
		<if test='CAMP_RS_CD != null and CAMP_RS_CD	 != ""'> AND A.CAMP_RS_CD = #{CAMP_RS_CD}</if>
	</select>

	<update id="updateClbkInqDiv"  parameterType= "java.util.HashMap" >
			<![CDATA[
			/* updateClbkInqDiv 콜백처리결과저장 */
			UPDATE PLT_PHN_CLBK_DST
			   SET
			       EOT_TY = #{EOT_TY_RLT}
			     , PROC_CODE = #{PROC_CODE}										/*처리구분*/
			     , CHNG_DTIM = TO_CHAR(NOW(),'YYYYMMDDHH24MISS')	/*변경일시*/
			     , CHNG_MAN = #{CHNG_MAN} 							/*변경자*/
			 WHERE CLBK_NO =  #{CLBK_NO}
			]]>
	</update>

	<select id="clbkStatHistList" parameterType="java.util.HashMap" resultType="java.util.HashMap">
		SELECT  /*콜백 이력 목록 (kr.co.hkcloud.palette3.phone.callback.dao.PhoneCallbackListMapper.clbkStatHistList)*/
		*
		, ROW_NUMBER() OVER(PARTITION BY A.CLBK_ID ORDER BY A.CUTT_BGNG_DT) AS ROW_NUMBER
		FROM (
		SELECT
			PPC.CUSTCO_ID
			, NULL::BIGINT AS PHN_CUTT_ID
			, PPCA.CLBK_ID
			, PPC.DRWI_DT
			, PPC.DRWI_SE_NM
			, PPC.ALTMNT_DT
			, PPCA.CUSL_ID
			, (SELECT USER_NM FROM PLT_USER WHERE USER_ID = PPCA.CUSL_ID) AS CUSL_NM
			, PPC.CUST_ID
			, PC.CUST_NM
			, PC.CUST_PHN_NO
			, PPC.CLBK_PHN_NO
			, (SELECT MAX(REG_DT) FROM PLT_PHN_CUTT WHERE CLBK_ID = PPCA.CLBK_ID AND CUST_ID = PPC.CUST_ID) AS MAX_REG_DT
			, (SELECT COUNT(CLBK_ID) FROM PLT_PHN_DSPTCH_HSTRY WHERE CLBK_ID = PPCA.CLBK_ID) 
				+ (SELECT COUNT(PHN_CUTT_ID) FROM PLT_PHN_CUTT WHERE CLBK_ID = PPCA.CLBK_ID AND CUSL_ID = PPCA.CUSL_ID AND CUST_ID = PPC.CUST_ID AND FORC_CRT_YN = 'Y') AS CALL_TRY_CNT
			, ''::VARCHAR(14) AS CUTT_BGNG_DT
			, ''::VARCHAR(14) AS CUTT_END_DT
			, NULL::BIGINT AS CUSL_RS_ID
			, COALESCE((SELECT DTL.ATTR_VL FROM PLT_EXPSN_ATTR ATTR
			LEFT OUTER JOIN PLT_PHN_CUTT_DTL_EXPSN DTL ON DTL.ATTR_ID = ATTR.ATTR_ID
			WHERE ATTR.CUSTCO_ID = PPC.CUSTCO_ID
			AND ATTR.BSC_PVSN_ATTR_YN = 'N' AND ATTR.SE = 'CONSEL' AND ATTR.EXPSN_ATTR_COL_ID = 'CUSL_RS' --상담 결과
			AND DTL.PHN_CUTT_ID = (SELECT MAX(PHN_CUTT_ID) FROM PLT_PHN_CUTT WHERE CLBK_ID = PPCA.CLBK_ID AND CUST_ID = PPC.CUST_ID)
			), 'PROCESSING') AS CUSL_RS_CD
			, COALESCE((SELECT COMM.CD_NM FROM PLT_EXPSN_ATTR ATTR
			LEFT OUTER JOIN PLT_PHN_CUTT_DTL_EXPSN DTL ON DTL.ATTR_ID = ATTR.ATTR_ID
			LEFT OUTER JOIN PLT_COMM_CD COMM ON COMM.CUSTCO_ID = #{CUSTCO_ID}::INT AND COMM.CD_ID = COALESCE(DTL.ATTR_VL, 'PROCESSING') AND COMM.GROUP_CD_ID = 'CUSL_RS' --상담 결과
			WHERE ATTR.CUSTCO_ID = PPC.CUSTCO_ID
			AND ATTR.BSC_PVSN_ATTR_YN = 'N' AND ATTR.SE = 'CONSEL' AND ATTR.EXPSN_ATTR_COL_ID = 'CUSL_RS' --상담 결과
			AND DTL.PHN_CUTT_ID = (SELECT MAX(PHN_CUTT_ID) FROM PLT_PHN_CUTT WHERE CLBK_ID = PPCA.CLBK_ID AND CUST_ID = PPC.CUST_ID)
			), '처리중') AS CUSL_RS_NM
			, NULL::BIGINT AS CAMP_RS_ID
			, ''::VARCHAR(500) AS CAMP_RS_CD
			, ''::VARCHAR(200) AS CAMP_RS_NM
			, ''::TEXT AS CUTT_CN
			, ROW_NUMBER() OVER(PARTITION BY PPCA.CLBK_ID, PPCA.CUSL_ID, PPC.CUST_ID ORDER BY PPCA.CLBK_ID, PPCA.CUSL_ID, PPC.CUST_ID) AS RNUM
		FROM PLT_PHN_CLBK_ALTMNT PPCA
		INNER JOIN PLT_PHN_CLBK PPC ON PPC.CLBK_ID = PPCA.CLBK_ID
		LEFT OUTER JOIN PLT_CUST PC ON PC.CUST_ID = PPC.CUST_ID
		WHERE PPC.CUSTCO_ID = #{CUSTCO_ID}::INT
		<if test='CUST_ID != null and CUST_ID != ""'>AND PPC.CUST_ID = #{CUST_ID}::INT</if>
		<if test='IS_ALL_ENV == "false" and CUSL_ID != null and CUSL_ID != ""'>AND PPCA.CUSL_ID = #{CUSL_ID}::INT</if>
		<if test='CLBK_ID != null and CLBK_ID != ""'>AND PPCA.CLBK_ID = #{CLBK_ID}::INT</if>
		UNION ALL
		SELECT
			PPC.CUSTCO_ID
			, PPC.PHN_CUTT_ID
			, PPC.CLBK_ID
			, (SELECT DRWI_DT FROM PLT_PHN_CLBK WHERE CLBK_ID = PPC.CLBK_ID) AS DRWI_DT
			, ''::VARCHAR(60) AS DRWI_SE_NM
			, ''::VARCHAR(14) AS ALTMNT_DT
			, PPC.CUSL_ID
			, (SELECT USER_NM FROM PLT_USER WHERE USER_ID = PPC.CUSL_ID) AS CUSL_NM
			, PPC.CUST_ID
			, (SELECT CUST_NM FROM PLT_CUST WHERE CUST_ID = PPC.CUST_ID) AS CUST_NM
			, ''::VARCHAR(60) AS CUST_PHN_NO
			, ''::VARCHAR(14) AS CLBK_PHN_NO
			, ''::VARCHAR(14) AS MAX_REG_DT
			, (SELECT COUNT(CLBK_ID) FROM PLT_PHN_DSPTCH_HSTRY WHERE CLBK_ID = PPC.CLBK_ID) 
				+ (SELECT COUNT(PHN_CUTT_ID) FROM PLT_PHN_CUTT WHERE CLBK_ID = PPC.CLBK_ID AND CUSL_ID = PPC.CUSL_ID AND CUST_ID = PPC.CUST_ID AND FORC_CRT_YN = 'Y') AS CALL_TRY_CNT
			, PPC.CUTT_BGNG_DT
			, PPC.CUTT_END_DT
			, PEA.ATTR_ID AS CUSL_RS_ID
			, COALESCE((SELECT PPCDE.ATTR_VL FROM PLT_PHN_CUTT_DTL_EXPSN PPCDE WHERE PPCDE.PHN_CUTT_ID = PPC.PHN_CUTT_ID AND PPCDE.ATTR_ID = PEA.ATTR_ID), 'PROCESSING') AS CUSL_RS_CD
			, (SELECT CD_NM FROM PLT_PHN_CUTT_DTL_EXPSN PPCDE INNER JOIN PLT_COMM_CD PCC ON PCC.CUSTCO_ID = #{CUSTCO_ID}::INT AND PCC.CD_ID = COALESCE(PPCDE.ATTR_VL, 'PROCESSING') AND PCC.GROUP_CD_ID = 'CUSL_RS' WHERE PPCDE.PHN_CUTT_ID = PPC.PHN_CUTT_ID AND PPCDE.ATTR_ID = PEA.ATTR_ID) AS CUSL_RS_NM
			, PEA2.ATTR_ID AS CAMP_RS_ID
			, (SELECT PPCDE.ATTR_VL FROM PLT_PHN_CUTT_DTL_EXPSN PPCDE WHERE PPCDE.PHN_CUTT_ID = PPC.PHN_CUTT_ID AND PPCDE.ATTR_ID = PEA2.ATTR_ID) AS CAMP_RS_ID
			, (SELECT CD_NM FROM PLT_PHN_CUTT_DTL_EXPSN PPCDE INNER JOIN PLT_COMM_CD PCC ON PCC.CUSTCO_ID = #{CUSTCO_ID}::INT AND PCC.CD_ID = PPCDE.ATTR_VL AND PCC.GROUP_CD_ID = 'CAMP_RS' WHERE PPCDE.PHN_CUTT_ID = PPC.PHN_CUTT_ID AND PPCDE.ATTR_ID = PEA2.ATTR_ID) AS CAMP_RS_CD
			, (SELECT CASE WHEN COALESCE(PEA3.INDI_INFO_ENCPT_YN, 'N') = 'Y' THEN CUSTCO.GEN_DECRYPT(CUTT_CN, #{PP_KEY_PP}, #{PP_ALG_PP}) ELSE CUTT_CN END FROM PLT_PHN_CUTT_DTL_CN PPCD INNER JOIN PLT_PHN_CUTT_DTL_EXPSN PPCDE ON PPCDE.PHN_CUTT_ID = PPCD.PHN_CUTT_ID AND PPCDE.ATTR_ID = PPCD.ATTR_ID WHERE PPCDE.PHN_CUTT_ID = PPC.PHN_CUTT_ID AND PPCDE.ATTR_ID = PEA3.ATTR_ID) AS CUTT_CN
			, ROW_NUMBER() OVER(PARTITION BY PPC.CLBK_ID, PPC.CUSL_ID, PPC.CUST_ID ORDER BY PPC.CLBK_ID, PPC.CUSL_ID, PPC.CUST_ID, PPC.PHN_CUTT_ID) AS RNUM
		FROM PLT_PHN_CUTT PPC
		LEFT OUTER JOIN PLT_EXPSN_ATTR PEA ON PEA.CUSTCO_ID = PPC.CUSTCO_ID AND PEA.BSC_PVSN_ATTR_YN = 'N' AND PEA.SE = 'CONSEL' AND PEA.EXPSN_ATTR_COL_ID = 'CUSL_RS' --상담결과
		LEFT OUTER JOIN PLT_EXPSN_ATTR PEA2 ON PEA2.CUSTCO_ID = PPC.CUSTCO_ID AND PEA2.BSC_PVSN_ATTR_YN = 'N' AND PEA2.SE = 'CONSEL' AND PEA2.EXPSN_ATTR_COL_ID = 'CAMP_RS' --처리 결과
		LEFT OUTER JOIN PLT_EXPSN_ATTR PEA3 ON PEA3.CUSTCO_ID = PPC.CUSTCO_ID AND PEA3.BSC_PVSN_ATTR_YN = 'N' AND PEA3.SE = 'CONSEL' AND PEA3.EXPSN_ATTR_COL_ID = 'CUSL_CN' --상담 내용
		WHERE PPC.CUSTCO_ID = #{CUSTCO_ID}::INT
		<if test='IS_ALL_ENV == "false" and CUST_ID != null and CUST_ID != ""'>
			AND EXISTS (SELECT 1 FROM PLT_PHN_CLBK_ALTMNT A
			INNER JOIN PLT_PHN_CLBK B ON B.CLBK_ID = A.CLBK_ID
			WHERE A.CLBK_ID = PPC.CLBK_ID AND A.CUSL_ID = PPC.CUSL_ID AND B.CUST_ID = PPC.CUST_ID
			AND B.CUST_ID = #{CUST_ID}::INT
			)
		</if>
		<if test='IS_ALL_ENV == "false" and CUSL_ID != null and CUSL_ID != ""'>
			AND PPC.CUSL_ID = #{CUSL_ID}::INT
		</if>
		AND EXISTS (
		    SELECT 1
		      FROM PLT_PHN_CLBK_ALTMNT A
		     INNER JOIN PLT_PHN_CLBK B ON B.CLBK_ID = A.CLBK_ID
		     WHERE A.CLBK_ID = PPC.CLBK_ID
		       <if test='IS_ALL_ENV == "false"'><!--   -->
		       	AND A.CUSL_ID = PPC.CUSL_ID
		       </if>
		       AND B.CUST_ID = PPC.CUST_ID
		)
		<if test='CLBK_ID != null and CLBK_ID != ""'>AND PPC.CLBK_ID = #{CLBK_ID}::INT</if>
		UNION ALL
		SELECT
			PPC.CUSTCO_ID
			, -1 AS PHN_CUTT_ID
			, PPC.CLBK_ID
			, (SELECT DRWI_DT FROM PLT_PHN_CLBK WHERE CLBK_ID = PPC.CLBK_ID) AS DRWI_DT
			, ''::VARCHAR(60) AS DRWI_SE_NM
			, ''::VARCHAR(14) AS ALTMNT_DT
			, PPDH.CUSL_ID
			, (SELECT USER_NM FROM PLT_USER WHERE USER_ID = PPDH.CUSL_ID) AS CUSL_NM
			, PPC.CUST_ID
			, (SELECT CUST_NM FROM PLT_CUST WHERE CUST_ID = PPC.CUST_ID) AS CUST_NM
			, ''::VARCHAR(60) AS CUST_PHN_NO
			, ''::VARCHAR(14) AS CLBK_PHN_NO
			, ''::VARCHAR(14) AS MAX_REG_DT
			, 0 AS CALL_TRY_CNT
			, PPDH.REG_DT as CUTT_BGNG_DT
			, '' as CUTT_END_DT
			, NULL::BIGINT AS CUSL_RS_ID
			<choose>
				<when test='CUSL_RS != null and CUSL_RS != ""'>
					, #{CUSL_RS}
				</when>
				<otherwise>
					, '' AS CUSL_RS_CD
				</otherwise>
			</choose>
			, '' AS CUSL_RS_NM
			, NULL::BIGINT AS CAMP_RS_ID
			, '' AS CAMP_RS_ID
			, '' AS CAMP_RS_CD
			, '' AS CUTT_CN
			, ROW_NUMBER() OVER(PARTITION BY PPC.CLBK_ID ORDER BY PPC.CLBK_ID, PPC.CUST_ID) AS RNUM
		FROM PLT_PHN_DSPTCH_HSTRY PPDH
		INNER JOIN PLT_PHN_CLBK PPC ON PPC.CLBK_ID = PPDH.CLBK_ID
		LEFT OUTER JOIN PLT_CUST PC ON PC.CUST_ID = PPC.CUST_ID
		WHERE PPC.CUSTCO_ID = #{CUSTCO_ID}::INT
		AND NOT EXISTS (
		    SELECT 1
		      FROM PLT_PHN_CUTT PPC2
		     WHERE PPDH.CLBK_ID = PPC2.CLBK_ID
				AND PPDH.CUSL_ID = PPC2.CUSL_ID
				and PPDH.CUST_ID = PPC2.CUST_ID
				and TO_TIMESTAMP(PPC2.CUTT_BGNG_DT, 'YYYYMMDDHH24MISS')  <![CDATA[<]]>  TO_TIMESTAMP(PPDH.REG_DT, 'YYYYMMDDHH24MISS') + INTERVAL '2 minute'
				and TO_TIMESTAMP(PPC2.CUTT_BGNG_DT, 'YYYYMMDDHH24MISS') > TO_TIMESTAMP(PPDH.REG_DT, 'YYYYMMDDHH24MISS')
		)
		<if test='CUST_ID != null and CUST_ID != ""'>AND PPC.CUST_ID = #{CUST_ID}::INT</if>
		<if test='CLBK_ID != null and CLBK_ID != ""'>AND PPDH.CLBK_ID = #{CLBK_ID}::INT</if>
		) A WHERE 1 = 1
		<if test='(SCH_CALL_ST_DT != null and SCH_CALL_ST_DT!= "") or (SCH_CALL_END_DT != null and SCH_CALL_END_DT!= "")'>
			<if test='SCH_CALL_ST_DT != null and SCH_CALL_ST_DT != ""'>
				AND A.DRWI_DT <![CDATA[>=]]> CONCAT(#{SCH_CALL_ST_DT}, '000000')::VARCHAR(14)
			</if>
			<if test='SCH_CALL_END_DT != null and SCH_CALL_END_DT!= ""'>
				AND A.DRWI_DT <![CDATA[<=]]> CONCAT(#{SCH_CALL_END_DT}, '235959')::VARCHAR(14)
			</if>
		</if>
		<if test='CALL_TRY_CNT != null and CALL_TRY_CNT != "" and CALL_TRY_CNT > "0"'>
			AND A.CALL_TRY_CNT <choose><when test='UPDOWN == "UP"'><![CDATA[>=]]></when><otherwise><![CDATA[<=]]></otherwise></choose> #{CALL_TRY_CNT}::INT
		</if>
		<if test='CAMP_RS_CD != null and CAMP_RS_CD != ""'>
			AND EXISTS (SELECT 1 FROM PLT_PHN_CUTT CUTT
			INNER JOIN PLT_EXPSN_ATTR ATTR ON ATTR.CUSTCO_ID = CUTT.CUSTCO_ID AND ATTR.BSC_PVSN_ATTR_YN = 'N' AND ATTR.SE = 'CONSEL' AND ATTR.EXPSN_ATTR_COL_ID = 'CAMP_RS'
			INNER JOIN PLT_PHN_CUTT_DTL_EXPSN DTL ON DTL.PHN_CUTT_ID = CUTT.PHN_CUTT_ID AND DTL.ATTR_ID = ATTR.ATTR_ID
			WHERE A.CUSTCO_ID = CUTT.CUSTCO_ID
			AND A.CLBK_ID = CUTT.CLBK_ID
			AND A.CUSL_ID = CUTT.CUSL_ID
			AND A.CUST_ID = CUTT.CUST_ID
			AND DTL.ATTR_VL = #{CAMP_RS_CD}
			)
		</if>
		<if test='CUSL_RS != null and CUSL_RS != ""'>
			AND A.CUSL_RS_CD = #{CUSL_RS}
		</if>
	</select>

	<select id="cuslClbkMonitor" parameterType="java.util.HashMap" resultType="java.util.HashMap">
		SELECT  /*상담원별 콜백 상태 조회 (kr.co.hkcloud.palette3.phone.callback.dao.PhoneCallbackListMapper.cuslClbkMonitor)*/
			COUNT(*) AS TARGET_CNT
			, SUM(COALESCE(A.COMPLETED_CNT, 0)) AS COMPLETED_CNT
			, COUNT(*) - SUM(COALESCE(A.COMPLETED_CNT, 0)) AS NO_COMPLETED_CNT
			, ROUND((SUM(COALESCE(A.COMPLETED_CNT, 0))::DECIMAL / COUNT(*)::DECIMAL) * 100, 2) AS COMPLETED_RATE
		FROM (
			SELECT
				PPC.CUSTCO_ID, PPCA.CLBK_ID, PPCA.CUSL_ID, PPC.CUST_ID
				, (SELECT CASE WHEN DTL.ATTR_VL = 'COMPLETED' THEN 1 ELSE 0 END FROM PLT_EXPSN_ATTR ATTR
					LEFT OUTER JOIN PLT_PHN_CUTT_DTL_EXPSN DTL ON DTL.ATTR_ID = ATTR.ATTR_ID
					WHERE ATTR.CUSTCO_ID = PPC.CUSTCO_ID
					AND ATTR.BSC_PVSN_ATTR_YN = 'N' AND ATTR.SE = 'CONSEL' AND ATTR.EXPSN_ATTR_COL_ID = 'CUSL_RS' --상담 결과
					AND DTL.PHN_CUTT_ID = (SELECT MAX(PHN_CUTT_ID) FROM PLT_PHN_CUTT WHERE CLBK_ID = PPCA.CLBK_ID AND CUST_ID = PPC.CUST_ID)
				) AS COMPLETED_CNT
			FROM PLT_PHN_CLBK_ALTMNT PPCA
			INNER JOIN PLT_PHN_CLBK PPC ON PPC.CLBK_ID = PPCA.CLBK_ID
			WHERE PPC.CUSTCO_ID = #{CUSTCO_ID}::INT
			<if test='IS_ALL_ENV == "false"'>
				AND PPCA.CUSL_ID = #{USER_ID}::INT
			</if>
		) A
	</select>

	<select id="cuslClbkDtlMonitor" parameterType="java.util.HashMap" resultType="java.util.HashMap">
		SELECT  /*상담원별 처리결과별 상태 조회 (kr.co.hkcloud.palette3.phone.callback.dao.PhoneCallbackListMapper.cuslClbkDtlMonitor)*/
			PCC.CD_ID
			, PCC.CD_NM
			, (SELECT COUNT(PPC.PHN_CUTT_ID) FROM PLT_PHN_CUTT PPC
				LEFT OUTER JOIN PLT_EXPSN_ATTR PEA ON PEA.CUSTCO_ID = PPC.CUSTCO_ID AND PEA.BSC_PVSN_ATTR_YN = 'N' AND PEA.SE = 'CONSEL' AND PEA.EXPSN_ATTR_COL_ID = 'CAMP_RS'
				LEFT OUTER JOIN PLT_PHN_CUTT_DTL_EXPSN PPCDE ON PPCDE.PHN_CUTT_ID = PPC.PHN_CUTT_ID AND PPCDE.ATTR_ID = PEA.ATTR_ID
				WHERE PPC.CUSTCO_ID = #{CUSTCO_ID}::INT
				AND PPC.CLBK_ID IS NOT NULL
				<if test='IS_ALL_ENV == "false"'>
					AND PPC.CUSL_ID = #{USER_ID}::INT
				</if>
				<if test='CUSL_RS != null and CUSL_RS != ""'>
					AND PPC.PHN_CUTT_ID IN (SELECT PHN_CUTT_ID
											FROM PLT_PHN_CUTT_DTL_EXPSN PPCDE2
											WHERE PPCDE2.ATTR_VL = #{CUSL_RS})
				</if>
				AND PPCDE.ATTR_VL = PCC.CD_ID
			) AS CNT
		FROM PLT_COMM_CD PCC
		WHERE PCC.CUSTCO_ID = #{CUSTCO_ID}::INT AND PCC.GROUP_CD_ID = 'CAMP_RS' ORDER BY PCC.SORT_ORD
	</select>
</mapper>

