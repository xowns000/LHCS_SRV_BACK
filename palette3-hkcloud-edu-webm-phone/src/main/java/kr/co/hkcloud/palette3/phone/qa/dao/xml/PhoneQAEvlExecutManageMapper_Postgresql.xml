<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
 
<mapper namespace="kr.co.hkcloud.palette3.dao.PhoneQAEvlExecutManageMapper">

	<!-- 상담이력조회 -->
<select id="selectRtn" parameterType= "java.util.HashMap" resultType="java.util.HashMap">

<![CDATA[
SELECT 
	TQE.QA_ID  				 AS QA_ID												/*QAID*/
	,TQE.QA_USER_ID			 AS QA_USER_ID  										/*QA평가자*/
	,TQE.QA_YM			 	 AS QA_YM  												/*QA평가년월*/
	,TQE.QA_SEQ				 AS QA_SEQ												/*QA회차*/
	,TQE.QA_FIN				 AS QA_FIN												/*QA평가마감*/
	,TAC.CENT_TY			 AS CENT_TY												/*센터구분*/
	,TAC.CUST_NM  		 	 AS CUST_NAME											/*고객명*/
	,TAC.CNSL_HIST_NO			 AS CNSL_ID											/*상담이력ID*/
	,(SELECT USER_NM FROM PLT_USER WHERE USER_ID = TQE.REG_ID )	AS 	REG_NM			/*등록자*/
	,TACD.CNSL_CNTN			 AS INQU_CTEN											/*상담질문*/
	,(TAC.CNSL_BEGIN_DATE ||	TAC.CNSL_BEGIN_TIME) AS  CNSL_BEGIN_DTIM			/*상담시작일시*/
	,(TAC.CNSL_EOT_DATE ||	TAC.CNSL_EOT_TIME) AS  CNSL_EOT_DTIM					/*상담종료일시*/
	,TAC.RDWT_ID 			AS 	RDWT_ID												/*녹취ID*/
	,TQE.REG_ID				AS USER_ID												/*등록자ID*/
	,NVL2(TAC.RDWT_ID ,'<button type="button" class="tt-btn is-icon"><i class="tt-icon-play"></i></button>','')  AS RDWT_ICON		/*녹취ID*/
FROM PLT_PHN_CNSL TAC
LEFT JOIN PLT_PHN_QA_EVAL TQE ON TQE.CNSL_ID  = TAC.CNSL_HIST_NO					/*QA평가*/ 
LEFT JOIN PLT_PHN_CNSL_DTL TACD ON TACD.CNSL_HIST_NO = TAC.CNSL_HIST_NO				/*상담질문*/
LEFT JOIN PLT_USER A			ON TAC.CSLT_ID = A.USER_ID							/*사용자 ID*/
WHERE TAC.DEL_YN = 'N'																/*삭제여부*/
AND TQE.QA_EXT_CHK = 'Y'															/*추출대상건*/
AND TQE.QA_END = 'Y'																/*등록마감건*/	

 ]]>
<!--  조회기간 -->
 <if test="SEARCH_FROM	!='' and SEARCH_FROM	!= null and SEARCH_TO	!='' and SEARCH_TO	!= null ">
 	 <![CDATA[
 	  	AND   TAC.CNSL_BEGIN_DATE  >=   TO_CHAR(CAST(#{SEARCH_FROM} AS INTEGER)-1)  
      	AND   TAC.CNSL_BEGIN_DATE <=  #{SEARCH_TO}   
	 ]]> 	 
 </if>

<!-- 평가완료여부 -->
<if test="QA_FIN != '' and QA_FIN != null">
AND TQE.QA_FIN = #{QA_FIN}
</if>
<!-- QA회차 -->
<if test="QA_SEQ != '' and QA_SEQ != null">
AND TQE.QA_SEQ = #{QA_SEQ}
</if>

<!-- QA유형 -->
<!-- <if test="QA_TY_ID !='' and QA_TY_ID != null"> -->
<!-- AND TQE.QA_TY_ID = #{QA_TY_ID} -->
<!-- </if> -->

<if test="USER_ID != ''">
	   	/*사용자ID*/
		AND A.USER_ID LIKE '%'|| #{USER_ID}|| '%'		
</if>
<if test="USER_NM != ''">
	   	/*사용자명*/
		AND A.USER_NM LIKE '%'|| #{USER_NM}|| '%'		
</if>
<if test="USER_NICK != ''">
	   	/*사용자닉네임*/
		AND A.USER_NICK LIKE '%'|| #{USER_NICK}|| '%'		
</if>


<if test="QA_USER_ID != ''">
	   	/*QA담당자ID*/
		AND A.USER_ID LIKE '%'|| #{QA_USER_ID}|| '%'		
</if>
<if test="QA_USER_NM != ''">
	   	/*QA담당자명*/
		AND A.USER_NM LIKE '%'|| #{QA_USER_NM}|| '%'		
</if>
<if test="QA_USER_NICK != ''">
	   	/*QA담당자닉네임*/
		AND A.USER_NICK LIKE '%'|| #{QA_USER_NICK}|| '%'		
</if>
	 
ORDER BY TAC.CNSL_HIST_NO DESC

</select>	



<!-- 상담이력상세조회 -->
<select id="selectRtnDetails" parameterType= "java.util.HashMap" resultType="java.util.HashMap">
SELECT 
	NVL2(TQE.QA_ID,'Y','N')  AS QA_ID		/*등록여부*/
	,TQE.QA_SEQ				AS QA_SEQ		/*QA회차*/
	,TAC.CUST_NM  		 AS CUST_NAME	/*고객명*/
	,TAC.CNSL_HIST_NO			 AS CNSL_ID		/*상담이력ID*/
	,(SELECT USER_NM FROM PLT_USER WHERE USER_ID = TQE.REG_ID )	AS 	REG_ID					/*등록자*/
	,TACD.CNSL_CNTN			 AS INQU_CTEN	/*상담질문*/
	,TACD.CNSL_CNTN			 AS REPL_CTEN	/*상담답변*/ 
	,(TAC.CNSL_BEGIN_DATE ||	TAC.CNSL_BEGIN_TIME) AS  CNSL_BEGIN_DTIM			/*상담시작일시*/
	,(TAC.CNSL_EOT_DATE ||	TAC.CNSL_EOT_TIME) AS  CNSL_EOT_DTIM					/*상담종료일시*/
	,TAC.RDWT_ID 			AS 	RDWT_ID												/*녹취ID*/
	,TAC.AF_PROC_TIME		AS AF_PROC_TIME											/*후처리시간*/
	,TAC.CUST_TEL_NO			AS CUST_TEL							/*암호화 필요 전화번호*/
	,TAC.TEL_TIME			AS TEL_TIME												/*통화시간*/
	,TAC.REG_DTIM			AS REG_DTIM												/*등록일시*/
	,(SELECT USER_NM FROM PLT_USER WHERE USER_ID = TQE.CHNG_ID )	AS 	CHNG_ID			/*수정자*/
	,TAC.CHNG_DTIM			AS CHNG_DTIM											/*수정일시*/
FROM PLT_PHN_CNSL TAC
LEFT JOIN PLT_PHN_QA_EVAL TQE ON TQE.CNSL_ID  = TAC.CNSL_HIST_NO 
LEFT JOIN PLT_PHN_CNSL_DTL TACD ON TACD.CNSL_HIST_NO = TAC.CNSL_HIST_NO				/*상담질문*/
WHERE TAC.CNSL_HIST_NO = #{CNSL_ID}
  AND TAC.DEL_YN = 'N'
ORDER BY TAC.CNSL_HIST_NO DESC
</select>

<!-- 평가마감 -->
<update id="processRtnEvaluationClose" parameterType= "java.util.HashMap" >
UPDATE PLT_PHN_QA_EVAL
SET 
	QA_FIN = 'Y'
WHERE CNSL_ID = #{CNSL_ID}
</update>

<!-- 평가마감취소 -->
<update id="processRtnCancel" parameterType= "java.util.HashMap" >
UPDATE PLT_PHN_QA_EVAL
SET 
	QA_FIN = ''
WHERE CNSL_ID = #{CNSL_ID}
</update>






</mapper>