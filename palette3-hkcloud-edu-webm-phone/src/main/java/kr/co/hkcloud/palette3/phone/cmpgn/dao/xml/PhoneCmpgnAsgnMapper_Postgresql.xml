<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
 
<mapper namespace="kr.co.hkcloud.palette3.phone.cmpgn.dao.PhoneCmpgnAsgnMapper">

<select id="selectRtn"  parameterType= "java.util.HashMap" resultType="java.util.HashMap">
SELECT ROW_NUMBER() OVER() AS ROW_NUMBER
		,A1.CAMP_SEQ, CAMP_NM, CAMP_TYPE_CD, CAMP_STAT_CD, STRT_DATE, END_DATE, SCRT_QTNA_TC, SCRT_QTNA_SEQ
				, CAMP_DESC, CHG_USER_ID, CHG_DT
				, FILE_CNT, DATA_CNT, EXTR_CNT, ERR_CNT, C1.ALLC_CNT, EXTR_CNT-ALLC_CNT NO_ALLC_CNT
				, REG_DT, REG_USER_ID
       FROM    (SELECT   A.CAMP_SEQ, COUNT(B.DATA_SEQ) FILE_CNT, SUM(DATA_CNT) DATA_CNT, SUM(EXTR_CNT) EXTR_CNT, SUM(ERR_CNT) ERR_CNT
		        FROM     UC_CMP_BASE A LEFT OUTER JOIN UC_CMP_DATA B ON A.CAMP_SEQ = B.CAMP_SEQ
		        WHERE 1=1
  <if test="TPL_NM != '' 	and TPL_NM != null">   	AND TPL_NM LIKE '%'||#{TPL_NM}||'%' </if>
  <if test="CAMP_NM != '' 	and CAMP_NM != null">  	AND CAMP_NM LIKE '%'||#{CAMP_NM}||'%' </if>
  <if test="CAMP_STAT_CD != '' 	and CAMP_STAT_CD != null">  	AND CAMP_STAT_CD = #{CAMP_STAT_CD} </if>
  <if test="CAMP_TYPE_CD != '' 	and CAMP_TYPE_CD != null">  	AND CAMP_TYPE_CD = #{CAMP_TYPE_CD} </if>
				GROUP BY A.CAMP_SEQ
		) A1 INNER JOIN  UC_CMP_BASE B2 ON  A1.CAMP_SEQ = B2.CAMP_SEQ
		LEFT JOIN 
       (SELECT CAMP_SEQ, SUM(CASE WHEN ALLC_AGNT_ID IS NOT NULL THEN 1 ELSE 0 END) AS ALLC_CNT 
        FROM UC_CMP_OBJ_LIST GROUP BY  CAMP_SEQ) C1 		
        ON A1.CAMP_SEQ = C1.CAMP_SEQ 
ORDER BY A1.CAMP_SEQ DESC  

</select>

<!--  캠페인 데이타 조회  -->
<select id="selectRtnData"  parameterType= "java.util.HashMap" resultType="java.util.HashMap">
SELECT ROW_NUMBER() OVER() AS ROW_NUMBER
     ,A.DATA_SEQ , A.CAMP_SEQ , VALUE(A.DEL_FLG,'N') DEL_FLG
     ,MAX(FILE_NM) FILE_NM
     ,FN_CODEBOOK('CMP005', MAX(DATA_TC)) AS DATA_TC_NM
     ,MAX(DATA_CNT) AS DATA_CNT
     ,MAX(EXTR_CNT) AS EXTR_CNT
	 ,MAX(ERR_CNT) AS ERR_CNT
     ,MAX(A.REG_DT) AS REG_DT
     ,FN_USER(MAX(A.REG_USER_ID),'') AS REG_USER_NM
     ,SUM(CASE WHEN ALLC_AGNT_ID IS NULL OR ALLC_AGNT_ID = '' THEN 0 ELSE 1 END ) AS ALLC_CNT
     ,SUM(CASE WHEN ALLC_AGNT_ID IS NULL OR ALLC_AGNT_ID = '' THEN 1 ELSE 0 END ) AS NO_ALLC_CNT
 FROM  UC_CMP_DATA A LEFT OUTER JOIN UC_CMP_OBJ_LIST B ON A.CAMP_SEQ = B.CAMP_SEQ AND  A.DATA_SEQ = B.DATA_SEQ
 WHERE  A.CAMP_SEQ = #{CAMP_SEQ} 
	AND A.DEL_FLG IS NULL 
 GROUP BY	A.CAMP_SEQ, A.DATA_SEQ , A.DEL_FLG
 ORDER BY	MAX(A.REG_DT) DESC

</select>

<!--  미할당 상담원 조회   -->
<select id="selectRtnUser"  parameterType= "java.util.HashMap" resultType="java.util.HashMap">
SELECT ROW_NUMBER() OVER() AS ROW_NUMBER
      ,'0' SELECTED, USER_ID, USER_NM, TEAM_LCD, TEAM_MCD, TEAM_SCD
FROM     UC_SYS_USER 
WHERE    USER_ID NOT IN (SELECT ALLC_AGNT_ID FROM UC_CMP_OBJ_LIST WHERE    CAMP_SEQ = #{CAMP_SEQ}
AND      DATA_SEQ = #{DATA_SEQ} AND  ALLC_AGNT_ID IS NOT NULL)
AND      USE_YN = 'Y'
  <if test="TEAM_LCD != '' 	and TEAM_LCD != null"> 	AND TEAM_LCD = #{TEAM_LCD} </if>
  <if test="TEAM_MCD != '' 	and TEAM_MCD != null"> 	AND TEAM_MCD = #{TEAM_MCD} </if>
  <if test="TEAM_SCD != '' 	and TEAM_SCD != null"> 	AND TEAM_SCD = #{TEAM_SCD} </if>
  <if test="USER_ID != '' 	and USER_ID != null">  	AND USER_ID = #{USER_ID} </if>
  <if test="USER_NM != '' 	and USER_NM != null">  	AND USER_NM LIKE '%'||#{USER_NM}||'%' </if>
ORDER BY USER_ID 

</select>


<!--  할당 상담원 조회   -->
<select id="selectRtnAllc"  parameterType= "java.util.HashMap" resultType="java.util.HashMap">
SELECT ROW_NUMBER() OVER() AS ROW_NUMBER
    ,'0' SELECTED, FN_USER(ALLC_AGNT_ID,'') USER_NM, ALLC_AGNT_ID USER_ID, COUNT(*) ALLC_CNT
	, SUM(CASE WHEN LAST_CALL_STAT_CD IS NULL THEN 1 ELSE 0 END ) NO_CALL_CNT
	, SUM(CASE WHEN LAST_CALL_STAT_CD IS NULL THEN 0 ELSE 1 END ) CALL_CNT
	, MAX(TEAM_LCD) TEAM_LCD, MAX(TEAM_MCD) TEAM_MCD, MAX(TEAM_SCD) TEAM_SCD, FN_CODEBOOK('SYS013',MAX(TEAM_LCD)) TEAM_LCD_NM
	, FN_CODEBOOK('CST115',MAX(TEAM_MCD)) TEAM_MCD_NM, FN_CODEBOOK('SYS015',MAX(TEAM_SCD))  TEAM_SCD_NM
FROM     UC_CMP_OBJ_LIST A, UC_SYS_USER B
WHERE    CAMP_SEQ = #{CAMP_SEQ}
  <if test="DATA_SEQ != '' 	and DATA_SEQ != null"> 	AND DATA_SEQ = #{DATA_SEQ} </if>
AND      ALLC_AGNT_ID IS NOT NULL
AND      A.ALLC_AGNT_ID = B.USER_ID
AND		 B.RTRM_DATE IS NULL
GROUP BY ALLC_AGNT_ID
ORDER BY ALLC_AGNT_ID

</select>

 <!--  프로젝트별 데이타 조회   -->
<select id="selectRtnPrjNo"  parameterType= "java.util.HashMap" resultType="java.util.HashMap">
SELECT
	 SUM(CASE WHEN ALLC_CNT = 0 THEN 0 ELSE 1 END ) AS ALLC_CNT
	,SUM(CASE WHEN NO_ALLC_CNT = 0 THEN 0 ELSE 1 END ) AS NO_ALLC_CNT
FROM
	(
		SELECT	
				 LAST_INTG_PRJ_NO					
				,SUM(CASE WHEN ALLC_AGNT_ID IS NULL OR ALLC_AGNT_ID = '' THEN 0 ELSE 1 END ) AS ALLC_CNT
				,SUM(CASE WHEN ALLC_AGNT_ID IS NULL OR ALLC_AGNT_ID = '' THEN 1 ELSE 0 END ) AS NO_ALLC_CNT
		  FROM  UC_CMP_OBJ_LIST
		 WHERE  CAMP_SEQ = #{CAMP_SEQ}
		   AND DATA_SEQ = #{DATA_SEQ}
		GROUP BY LAST_INTG_PRJ_NO
	) A

</select>
	
<!--  UC_CMP_대상_리스트  조회   -->
<select id="selectRtnInfo"  parameterType= "java.util.HashMap" resultType="java.util.HashMap">
SELECT COUNT(*) AS CNT 
FROM UC_CMP_OBJ_LIST
WHERE CAMP_SEQ = #{CAMP_SEQ}
AND   DATA_SEQ = #{DATA_SEQ}

</select>

<!-- UC_CMP_OBJ_LIST(캠페인할당) 테이블 데이터 등록 -->
<insert id="INSERT_UC_CMP_OBJ_LIST"  parameterType= "java.util.HashMap">
  		INSERT INTO UC_CMP_OBJ_LIST 
  		(
  			 CAMP_SEQ
  			,LIST_SEQ
  			,DATA_SEQ
  			,CUST_NO
  			,CUST_TC
  			,CUST_NM
  			,JBCL_CD
  			,LAST_INTG_PRJ_NO
			,LAST_DEAL_LINE_DIV
			,PRJ_NO
			,HO_NO
  			,CUST_TNO
  			,CALL_TNO
  			,MOBL_TNO
  			,ETC1_TNO
  			,HPCL_TEL_DIV
  			,RECV_RJT_YN
  			,BL_YN
  			,MEMO
  			,SPF_ITEM
  			,REG_DT
  			,REG_USER_ID
  			,CHG_DT
  			,CHG_USER_ID
			,ACPT_NO
  		)
  		VALUES
  		(
  			 #{CAMP_SEQ}
  			,#{LIST_SEQ}
  			,#{DATA_SEQ}
  			,#{CUST_NO}
  			,#{CUST_TC}
  			,#{CUST_NM}
  			,#{JBCL_CD}
  			,#{LAST_INTG_PRJ_NO}
			,#{LAST_DEAL_LINE_DIV}
			,#{PRJ_NO}
			,#{HO_NO}
  			,#{CUST_TNO}
  			,#{CALL_TNO}
  			,#{MOBL_TNO}
  			,#{ETC1_TNO}
  			,#{HPCL_TEL_DIV}
  			,#{RECV_RJT_YN}
  			,#{BL_YN}
  			,#{MEMO}
  			,#{SPF_ITEM}
  			,UF_NOW()('CURRENT', 'YYYYMMDDHH24MISS', 0)
  			,#{REG_USER_ID}
  			,UF_NOW()('CURRENT', 'YYYYMMDDHH24MISS', 0)
  			,#{CHG_USER_ID}
			,#{ACPT_NO}
  		)
</insert>	
	
<!-- 캠페인할당 실행  -->
<update id="UPDATE_UC_CMP_OBJ_LIST_1"  parameterType= "java.util.HashMap" >
    <![CDATA[
	 UPDATE UC_CMP_OBJ_LIST
       SET 		AGNT_ALLC_DT = UF_NOW()('CURRENT', 'YYYYMMDDHH24MISS', 0) 
		   				, ALLC_AGNT_ID = #{ALLC_AGNT_ID}
	  	 WHERE  CAMP_SEQ = #{CAMP_SEQ}
	     AND    DATA_SEQ = #{DATA_SEQ}
	     AND    (ALLC_AGNT_ID IS NULL OR ALLC_AGNT_ID = '')
	     AND  	LIST_SEQ IN(
					   SELECT A.LIST_SEQ 
					   FROM (
			 					SELECT LIST_SEQ , ROWNUMBER() OVER (ORDER BY LIST_SEQ) AS ROWNUM 
			   					FROM UC_CMP_OBJ_LIST 
									WHERE CAMP_SEQ = #{CAMP_SEQ}
										AND    DATA_SEQ = #{DATA_SEQ}
										AND    (ALLC_AGNT_ID IS NULL OR ALLC_AGNT_ID = '')
					 		) A 
					  WHERE A.ROWNUM <= COALESCE(#{APPLY_CNT}, 0)
					  )
    ]]>					  
</update>

<!-- 캠페인할당 실행 프로젝트별  -->
<update id="UPDATE_UC_CMP_OBJ_LIST_2"  parameterType= "java.util.HashMap" >
    <![CDATA[
	 UPDATE UC_CMP_OBJ_LIST
       SET 		AGNT_ALLC_DT = UF_NOW()('CURRENT', 'YYYYMMDDHH24MISS', 0) 
		   				, ALLC_AGNT_ID = #{ALLC_AGNT_ID}
	  	 WHERE  CAMP_SEQ = #{CAMP_SEQ}
	     AND    DATA_SEQ = #{DATA_SEQ}
	     AND    (ALLC_AGNT_ID IS NULL OR ALLC_AGNT_ID = '')
	     AND  	LAST_INTG_PRJ_NO IN(
					   SELECT A.LAST_INTG_PRJ_NO 
					   FROM (
			 					SELECT LAST_INTG_PRJ_NO , ROWNUMBER() OVER (ORDER BY LAST_INTG_PRJ_NO) AS ROWNUM 
			   					FROM UC_CMP_OBJ_LIST 
									WHERE CAMP_SEQ = #{CAMP_SEQ}
										AND    DATA_SEQ = #{DATA_SEQ}
										AND    (ALLC_AGNT_ID IS NULL OR ALLC_AGNT_ID = '')
								GROUP BY LAST_INTG_PRJ_NO
					 		) A 
					  WHERE A.ROWNUM <= COALESCE(#{APPLY_CNT}, 0)
					  )
    ]]>					  
</update>

<!-- 캠페인할당 회수  -->
<update id="UPDATE_UC_CMP_OBJ_LIST_3"  parameterType= "java.util.HashMap" >
 	 UPDATE UC_CMP_OBJ_LIST
       SET 		AGNT_ALLC_DT = NULL
		   		, ALLC_AGNT_ID = NULL
	  	 WHERE  CAMP_SEQ = #{CAMP_SEQ}
	     AND    DATA_SEQ = #{DATA_SEQ}
	     AND    ALLC_AGNT_ID  = #{ALLC_AGNT_ID}
	     AND    LAST_CALL_STAT_CD IS NULL
</update>

<!--  UC_CMP_대상_리스트  조회   -->
<delete id="DELETE_UC_CMP_OBJ_LIST"  parameterType= "java.util.HashMap" >
DELETE FROM UC_CMP_OBJ_LIST
WHERE CAMP_SEQ = #{CAMP_SEQ}
AND   DATA_SEQ = #{DATA_SEQ}
</delete>

</mapper>