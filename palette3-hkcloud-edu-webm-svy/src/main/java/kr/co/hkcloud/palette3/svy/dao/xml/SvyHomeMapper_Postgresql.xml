<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.co.hkcloud.palette3.svy.dao.SvyHomeMapper">
	<select id="selectStatusStat" parameterType="java.util.HashMap" resultType="java.util.HashMap">
		SELECT 
			COUNT(*) TOT_COUNT, 
			COALESCE(SUM(CASE WHEN STTS_CD = 'PRPARG' THEN 1 ELSE 0 END),0) PRPARG_COUNT,
			COALESCE(SUM(CASE WHEN STTS_CD = 'ONGONG' THEN 1 ELSE 0 END),0) ONGONG_COUNT,
			COALESCE(SUM(CASE WHEN STTS_CD = 'TERMIAT' THEN 1 ELSE 0 END),0) TERMIAT_COUNT
		FROM PLT_SRVY
		WHERE 
			CUSTCO_ID = #{CUSTCO_ID}::BIGINT
			AND DEL_YN = 'N'
			AND #{SRVY_YEAR_MONTH} BETWEEN SUBSTRING(SRVY_BGNG_DT,1,6) AND SUBSTRING(SRVY_END_DT,1,6)
	</select>
	
	<select id="selectBySeStat" parameterType="java.util.HashMap" resultType="java.util.HashMap">
		SELECT 
			PS.SRVY_SE_CD, 
			COUNT(*) SRVY_COUNT,
			PCC.CD_NM,
			PCC.SORT_ORD 
		FROM PLT_SRVY PS
		LEFT OUTER JOIN PLT_COMM_CD PCC
			ON PCC.CD_ID = PS.SRVY_SE_CD AND PCC.GROUP_CD_ID = 'SUVY_CL' AND PCC.CUSTCO_ID = PS.CUSTCO_ID
		WHERE 
			PS.CUSTCO_ID = #{CUSTCO_ID}::BIGINT
			AND PS.DEL_YN = 'N'
			AND #{SRVY_YEAR_MONTH} BETWEEN SUBSTRING(PS.SRVY_BGNG_DT,1,6) AND SUBSTRING(PS.SRVY_END_DT,1,6)
		GROUP BY PS.SRVY_SE_CD, PCC.CD_NM, PCC.SORT_ORD 
		ORDER BY PCC.SORT_ORD 
	</select>
	
	<select id="selectRspnsRateStat" parameterType="java.util.HashMap" resultType="java.util.HashMap">
		SELECT /*	selectRspnsRateStat - 참여율 현황 통계 조회	*/
			PS.SRVY_ID,
			PS.SRVY_NM,
			COUNT(*) TOT_COUNT,
			SUM(CASE WHEN PST.SRVY_RSPNS_DT IS NOT NULL THEN 1 ELSE 0 END) COUNT,
			ROUND(((SUM(CASE WHEN PST.SRVY_RSPNS_DT IS NOT NULL THEN 1 ELSE 0 END)::NUMERIC / COUNT(*)::NUMERIC) * 100.0::NUMERIC)::NUMERIC, 2) RATE
		FROM PLT_SRVY_TRGT PST 
		INNER JOIN PLT_SRVY PS 
			ON PS.SRVY_ID = PST.SRVY_ID AND PS.CUSTCO_ID = #{CUSTCO_ID}::INTEGER
		WHERE 
			PS.DEL_YN = 'N'
			AND PST.DEL_YN = 'N'
			AND #{SRVY_YEAR_MONTH} BETWEEN SUBSTRING(PS.SRVY_BGNG_DT,1,6) AND SUBSTRING(PS.SRVY_END_DT,1,6)
		GROUP BY PS.SRVY_ID, PS.SRVY_NM
		<choose>
			<when test='TOP3_YN != null and TOP3_YN == "Y"'>
				ORDER BY COUNT DESC
				LIMIT 3
			</when>
			<otherwise>
				ORDER BY PS.SRVY_ID DESC
			</otherwise>
		</choose>
	</select>
	
	<select id="selectGoalRateStat" parameterType="java.util.HashMap" resultType="java.util.HashMap">
		SELECT /*	selectGoalRateStat - 달성율 현황 통계 조회 */
			PS.SRVY_ID,
			PS.SRVY_NM,
			PS.GOAL_PSNAL TOT_COUNT,
			SUM(CASE WHEN PST.SRVY_RSPNS_DT IS NOT NULL THEN 1 ELSE 0 END) COUNT,
			ROUND(((SUM(CASE WHEN PST.SRVY_RSPNS_DT IS NOT NULL THEN 1 ELSE 0 END)::NUMERIC / PS.GOAL_PSNAL::NUMERIC) * 100.0::NUMERIC)::NUMERIC, 2) RATE
		FROM PLT_SRVY_TRGT PST 
		INNER JOIN PLT_SRVY PS 
			ON PS.SRVY_ID = PST.SRVY_ID AND PS.CUSTCO_ID = #{CUSTCO_ID}::INTEGER
		WHERE 
			PS.DEL_YN = 'N'
			AND PST.DEL_YN = 'N'
			AND GOAL_PSNAL_DSGN_YN = 'Y'
			AND #{SRVY_YEAR_MONTH} BETWEEN SUBSTRING(PS.SRVY_BGNG_DT,1,6) AND SUBSTRING(PS.SRVY_END_DT,1,6)
		GROUP BY PS.SRVY_ID, PS.SRVY_NM
		ORDER BY PS.SRVY_ID DESC
	</select>
	
	<select id="selectBySndngSeStat" parameterType="java.util.HashMap" resultType="java.util.HashMap">
		WITH SNDNG_HSTRY AS ( /*	selectBySndngSeStat - 발송 유형별 현황 통계 조회 */
			SELECT CUSTCO_ID, MTS_SNDNG_HSTRY_ID AS SNDNG_ID, (CASE WHEN PMSH.SNDNG_SE_CD IN('SMS','LMS','MMS') THEN 'SMS' ELSE PMSH.SNDNG_SE_CD END) AS SNDNG_SE_CD, PMSH.SRVY_TRGT_ID, PMSH.SNDNG_DT 
			FROM PLT_MTS_SNDNG_HSTRY PMSH
			WHERE SNDNG_DT IS NOT NULL AND PMSH.SRVY_TRGT_ID IS NOT NULL AND PMSH.CUSTCO_ID = #{CUSTCO_ID}::INTEGER
			UNION
			SELECT CUSTCO_ID, EML_SNDNG_ID AS SNDNG_ID, 'EMAIL' AS SNDNG_SE_CD, PESH.SRVY_TRGT_ID, PESH.SNDNG_DT 
			FROM PLT_EML_SNDNG_HSTRY PESH
			WHERE SNDNG_DT IS NOT NULL AND PESH.SRVY_TRGT_ID IS NOT NULL AND PESH.CUSTCO_ID = #{CUSTCO_ID}::INTEGER
		)
		SELECT 
			(CASE WHEN SH.SNDNG_SE_CD = 'ATALK' THEN 1 WHEN SH.SNDNG_SE_CD = 'SMS' THEN 2 WHEN SH.SNDNG_SE_CD = 'EMAIL' THEN 3 ELSE 999 END) AS SORT_ORD, 
			SNDNG_SE_CD, 
			(CASE WHEN SH.SNDNG_SE_CD = 'ATALK' THEN '#F9E200' WHEN SH.SNDNG_SE_CD = 'SMS' THEN '#1DCFBF' WHEN SH.SNDNG_SE_CD = 'EMAIL' THEN '#F26161' END) AS COLOR, 
			COUNT(SH.SNDNG_SE_CD) AS SEND_COUNT
		FROM SNDNG_HSTRY SH
		INNER JOIN PLT_SRVY_TRGT PST 
			ON SH.SRVY_TRGT_ID = PST.SRVY_TRGT_ID
		INNER JOIN PLT_SRVY PS 
			ON PS.SRVY_ID = PST.SRVY_ID AND PS.CUSTCO_ID = #{CUSTCO_ID}::INTEGER
		WHERE 
			PS.DEL_YN = 'N'
			AND PST.DEL_YN = 'N'
			AND #{SRVY_YEAR_MONTH} BETWEEN SUBSTRING(PS.SRVY_BGNG_DT,1,6) AND SUBSTRING(PS.SRVY_END_DT,1,6)
		GROUP BY SNDNG_SE_CD
		ORDER BY SORT_ORD
	</select>
	
	<select id="selectApprStat" parameterType="java.util.HashMap" resultType="java.util.HashMap">
		SELECT 
			COUNT(*) TOT_COUNT, 
			COALESCE(SUM(CASE WHEN STTS_CD = 'APPR' THEN 1 ELSE 0 END),0) APPR_COUNT,
			COALESCE(SUM(CASE WHEN STTS_CD = 'RDY' THEN 1 ELSE 0 END),0) RDY_COUNT,
			COALESCE(SUM(CASE WHEN STTS_CD = 'RFSL' THEN 1 ELSE 0 END),0) RFSL_COUNT,
			COALESCE(SUM(CASE WHEN STTS_CD = 'RTRVL' THEN 1 ELSE 0 END),0) RTRVL_COUNT
		FROM PLT_SRVY
		WHERE 
			CUSTCO_ID = #{CUSTCO_ID}::BIGINT
			AND DEL_YN = 'N'
			AND #{SRVY_YEAR_MONTH} BETWEEN SUBSTRING(SRVY_BGNG_DT,1,6) AND SUBSTRING(SRVY_END_DT,1,6)
	</select>
	
</mapper>