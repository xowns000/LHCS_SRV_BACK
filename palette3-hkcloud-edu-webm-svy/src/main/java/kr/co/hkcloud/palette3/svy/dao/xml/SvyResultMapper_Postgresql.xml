<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.co.hkcloud.palette3.svy.dao.SvyResultMapper">

	<!-- 분석결과 요약 조회 -->
	<select id="selectSummyList" parameterType="java.util.HashMap" resultType="java.util.HashMap">
		SELECT	 /* selectSummyList 분석결과 요약 조회 */
				 Q.SRVY_ID
				,(CASE WHEN Q.GOAL_PSNAL_DSGN_YN = 'Y' THEN '목표 설정' ELSE '없음' END) AS PRG_MTD
				,(CASE WHEN Q.GOAL_PSNAL_DSGN_YN = 'Y' THEN Q.GOAL_PSNAL::TEXT ELSE '0' END) AS TRGT_PER
				,Q.ANSR_CNT
				,(CASE WHEN Q.GOAL_PSNAL_DSGN_YN = 'Y' THEN ROUND((Q.ANSR_CNT::DECIMAL/Q.GOAL_PSNAL::DECIMAL)*100, 2)::TEXT ELSE '0' END) AS ACH_RAT
				,Q.SRVY_NM
				,TO_CHAR(TO_TIMESTAMP(Q.SRVY_BGNG_DT,'YYYYMMDDHH24MISS'), 'YYYY-MM-DD HH24:MI:SS')  AS SRVY_BGNG_DT
				,TO_CHAR(TO_TIMESTAMP(Q.SRVY_END_DT,'YYYYMMDDHH24MISS'), 'YYYY-MM-DD HH24:MI:SS') AS SRVY_END_DT
				,Q.STTS_CD
				,Q.CD_NM
				,Q.TOT_CNT
				,Q.USER_NM
		FROM (
			SELECT	 A.SRVY_ID
					,A.GOAL_PSNAL_DSGN_YN
					,A.GOAL_PSNAL
					,(SELECT COUNT(X.SRVY_TRGT_ID) FROM PLT_SRVY_TRGT X WHERE A.SRVY_ID = X.SRVY_ID AND X.DEL_YN = 'N' AND COALESCE(X.SRVY_RSPNS_DT,'') != '') AS ANSR_CNT
					,A.SRVY_NM
					,A.SRVY_BGNG_DT
					,A.SRVY_END_DT
					,A.STTS_CD
					,C.CD_NM
					,SUM((SELECT COUNT(X.SRVY_QITEM_ID) FROM PLT_SRVY_QITEM X WHERE X.SRVY_QITEM_GROUP_ID = B.SRVY_QITEM_GROUP_ID AND X.DEL_YN = 'N')) AS TOT_CNT
					,D.USER_NM
			FROM 	PLT_SRVY A
			LEFT OUTER JOIN PLT_SRVY_QITEM_GROUP B
				ON A.SRVY_ID = B.SRVY_ID AND B.DEL_YN = 'N' AND B.HEAD_YN = 'N'
			LEFT OUTER JOIN PLT_COMM_CD C
				ON A.STTS_CD = C.CD_ID AND C.GROUP_CD_ID = 'PROG_ST' AND C.CUSTCO_ID = #{CUSTCO_ID}::INTEGER
			LEFT OUTER JOIN PLT_USER D
				ON A.RGTR_ID = D.USER_ID AND D.USE_YN = 'Y'
			WHERE A.SRVY_ID = #{SRVY_ID}::INTEGER
			AND	A.DEL_YN = 'N'
			GROUP BY A.SRVY_ID
					,A.GOAL_PSNAL_DSGN_YN
					,A.GOAL_PSNAL
					,A.SRVY_NM
					,A.SRVY_BGNG_DT
					,A.SRVY_END_DT
					,A.STTS_CD
					,C.CD_NM
					,D.USER_NM

		) Q
	</select>

	<!-- 분석결과 항목 조회 -->
	<select id="selectSummyItem" parameterType="java.util.HashMap" resultType="java.util.HashMap">
		SELECT 	 /* selectSummyItem 분석결과 항목 조회 */
				 X.SRVY_QITEM_GROUP_ID
				,X.SRVY_QITEM_ID
				,X.SRVY_QITEM_CN
				,X.QITEM_CHC_ID
				,X.QITEM_CHC_CN
				,X.QITEM_TYPE_CUST
				,SUM(X.CNT) AS CNT
		FROM (
			SELECT	 A.SRVY_QITEM_GROUP_ID
					,B.SRVY_QITEM_ID
					,B.SRVY_QITEM_CN
					,B.SRVY_QITEM_EXPLN
					,B.QITEM_TYPE_CD
					,(CASE WHEN B.QITEM_TYPE_CD IN ('SNGL','MULT') THEN C.QITEM_CHC_ID ELSE E.SRVY_TRGT_ID END) QITEM_CHC_ID
					,(CASE WHEN B.QITEM_TYPE_CD IN ('SNGL','MULT') THEN (CASE WHEN C.RSPNS_USE_YN = 'Y' THEN 'MSG_ETC' ELSE C.QITEM_CHC_CN END) ELSE E.RSPNS_CN END) QITEM_CHC_CN
					,(CASE WHEN D.SRVY_TRGT_ID IS NULL THEN 0 ELSE 1 END) AS CNT
					,(CASE WHEN B.QITEM_TYPE_CD IN ('SHOT','DESC','DATE') THEN 'ETC' ELSE B.QITEM_TYPE_CD END) QITEM_TYPE_CUST
					,A.SORT_ORD AS ORD_A
					,B.SORT_ORD AS ORD_B
					,C.SORT_ORD AS ORD_C
			FROM PLT_SRVY_QITEM_GROUP A
			LEFT OUTER JOIN PLT_SRVY_QITEM B
				ON A.SRVY_QITEM_GROUP_ID = B.SRVY_QITEM_GROUP_ID AND B.DEL_YN = 'N'
			LEFT OUTER JOIN PLT_SRVY_QITEM_CHC C
				ON B.SRVY_QITEM_ID = C.SRVY_QITEM_ID AND C.DEL_YN = 'N'
			LEFT OUTER JOIN PLT_SRVY_TRGT F
				ON A.SRVY_ID = F.SRVY_ID AND F.DEL_YN = 'N' AND COALESCE(F.SRVY_RSPNS_DT,'') != ''
			LEFT OUTER JOIN PLT_SRVY_RSPNS_QITEM_CHC D
				ON B.SRVY_QITEM_ID = D.SRVY_QITEM_ID AND C.QITEM_CHC_ID = D.QITEM_CHC_ID AND F.SRVY_TRGT_ID = D.SRVY_TRGT_ID
			LEFT OUTER JOIN PLT_SRVY_RSPNS_DSCRT E
				ON B.SRVY_QITEM_ID = E.SRVY_QITEM_ID AND F.SRVY_TRGT_ID = E.SRVY_TRGT_ID
			WHERE 	A.SRVY_ID = #{SRVY_ID}::INTEGER
			<if test="CNT > 0">
				AND B.QITEM_TYPE_CD IN (
				<foreach collection="LIST_TYPE" item="ITEM" close="" separator=",">
					#{ITEM.TYPES}
				</foreach>
				)
			</if>
			AND		A.DEL_YN = 'N'
			AND		A.HEAD_YN = 'N'
			AND		(F.SRVY_RSPNS_DT IS NOT NULL OR F.SRVY_RSPNS_DT != '')
			<if test="F_DATE != 'false'">
				<![CDATA[
					AND		F.SRVY_RSPNS_DT >= REPLACE(#{S_DATE},'-','') || '000000'
					AND 	F.SRVY_RSPNS_DT <= REPLACE(#{E_DATE},'-','') || '999999'
				]]>
			</if>
		) X
		GROUP BY X.SRVY_QITEM_GROUP_ID
				,X.SRVY_QITEM_ID
				,X.SRVY_QITEM_CN
				,X.QITEM_CHC_ID
				,X.QITEM_CHC_CN
				,X.QITEM_TYPE_CUST
				,X.ORD_A
				,X.ORD_B
				,X.ORD_C
		ORDER BY X.ORD_A, X.ORD_B, X.ORD_C
	</select>

	<!-- 분석결과 항목 자세히 조회 -->
	<select id="selectDetailList" parameterType="java.util.HashMap" resultType="java.util.HashMap">
		SELECT	 /* selectDetailList 분석결과 항목 자세히 조회 */
				 A.SRVY_TRGT_ID
				,S.TRGT_DSGN_YN
				,CUSTCO.GEN_DECRYPT(A.CUST_NM, #{PP_KEY_PP}, #{PP_ALG_PP}) AS CUST_NM
				,CUSTCO.GEN_DECRYPT(A.CUST_PHN_NO, #{PP_KEY_PP}, #{PP_ALG_PP}) AS CUST_PHN_NO
				,CUSTCO.GEN_DECRYPT(A.EML, #{PP_KEY_PP}, #{PP_ALG_PP}) AS EML
				,TO_CHAR(TO_TIMESTAMP(A.SRVY_RSPNS_DT,'YYYYMMDDHH24MISS'), 'YYYY-MM-DD HH24:MI:SS')  AS SRVY_RSPNS_DT
				,B.SRVY_QITEM_GROUP_ID
				,B.SRVY_QITEM_GROUP_NM
				,C.SRVY_QITEM_ID
				,C.SRVY_QITEM_CN
				,C.QITEM_TYPE_CD
				,(CASE WHEN C.QITEM_TYPE_CD IN ('SNGL','MULT') THEN E.QITEM_CHC_ID ELSE F.SRVY_TRGT_ID END) QITEM_CHC_ID
				,(CASE WHEN C.QITEM_TYPE_CD IN ('SNGL','MULT') THEN (CASE WHEN E.RSPNS_USE_YN = 'Y' THEN D.RSPNS_CN WHEN C.SCR_USE_YN = 'Y' THEN E.SCR::TEXT ELSE E.QITEM_CHC_CN END) ELSE F.RSPNS_CN END) QITEM_CHC_CN
				<if test="EXPSN_ATTR_LIST != null">
					<foreach collection="EXPSN_ATTR_LIST" item="ATTR" open="" separator="" close="" >
						<if test='ATTR.ATTR_ID != null and ATTR.ATTR_ID != ""'>
							, (SELECT ATTR_VL FROM PLT_SRVY_TRGT_DTL PSTD WHERE PSTD.SRVY_TRGT_ID = A.SRVY_TRGT_ID AND ATTR_ID = '${ATTR.ATTR_ID}'::INT) AS ${ATTR.EXPSN_ATTR_COL_ID}
						</if>
					</foreach>
				</if>
		FROM 	PLT_SRVY_TRGT A
		INNER JOIN PLT_SRVY S ON S.SRVY_ID = A.SRVY_ID AND S.CUSTCO_ID = #{CUSTCO_ID}::INTEGER
		LEFT OUTER JOIN PLT_SRVY_QITEM_GROUP B
			ON A.SRVY_ID = B.SRVY_ID AND B.HEAD_YN = 'N' AND B.DEL_YN = 'N'
		LEFT OUTER JOIN PLT_SRVY_QITEM C
			ON B.SRVY_QITEM_GROUP_ID = C.SRVY_QITEM_GROUP_ID AND C.DEL_YN = 'N'
		LEFT OUTER JOIN PLT_SRVY_RSPNS_QITEM_CHC D
			ON A.SRVY_TRGT_ID = D.SRVY_TRGT_ID AND C.SRVY_QITEM_ID = D.SRVY_QITEM_ID
		LEFT OUTER JOIN PLT_SRVY_QITEM_CHC E
			ON C.SRVY_QITEM_ID = E.SRVY_QITEM_ID AND D.QITEM_CHC_ID = E.QITEM_CHC_ID AND E.DEL_YN = 'N'
		LEFT OUTER JOIN PLT_SRVY_RSPNS_DSCRT F
			ON A.SRVY_TRGT_ID = F.SRVY_TRGT_ID AND C.SRVY_QITEM_ID = F.SRVY_QITEM_ID
		WHERE	A.SRVY_ID = #{SRVY_ID}::INTEGER
		AND	(A.SRVY_RSPNS_DT IS NOT NULL OR A.SRVY_RSPNS_DT != '')
		AND A.DEL_YN = 'N'
		ORDER BY B.SORT_ORD, C.SORT_ORD, A.SRVY_TRGT_ID
	</select>

</mapper>