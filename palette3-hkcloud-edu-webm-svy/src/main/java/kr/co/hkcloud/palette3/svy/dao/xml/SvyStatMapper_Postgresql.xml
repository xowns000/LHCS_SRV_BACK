<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.co.hkcloud.palette3.svy.dao.SvyStatMapper">
	<select id="selectSendList" parameterType="java.util.HashMap" resultType="java.util.HashMap">
	WITH SNDNG_HSTRY AS ( /*	selectSendList - 설문조사 발송 내역 조회 */
		SELECT MTS_SNDNG_HSTRY_ID AS SNDNG_ID, SNDNG_SE_CD, PMSH.SRVY_TRGT_ID, PMSH.SNDNG_DT 
		FROM PLT_MTS_SNDNG_HSTRY PMSH
		WHERE SNDNG_DT IS NOT NULL AND PMSH.SRVY_TRGT_ID IS NOT NULL AND PMSH.CUSTCO_ID = #{CUSTCO_ID}::INTEGER
		UNION
		SELECT EML_SNDNG_ID AS SNDNG_ID, 'EMAIL' AS SNDNG_SE_CD , PESH.SRVY_TRGT_ID, PESH.SNDNG_DT 
		FROM PLT_EML_SNDNG_HSTRY PESH
		WHERE SNDNG_DT IS NOT NULL AND PESH.SRVY_TRGT_ID IS NOT NULL AND PESH.CUSTCO_ID = #{CUSTCO_ID}::INTEGER
	) 
	SELECT
		ROW_NUMBER() OVER(ORDER BY SH.SNDNG_DT DESC) AS ROW_NUMBER,
		SH.SNDNG_ID,
		(CASE WHEN SH.SNDNG_SE_CD IN('SMS','LMS','MMS') THEN 'SMS' ELSE SH.SNDNG_SE_CD END) AS SNDNG_SE_CD,
		SH.SRVY_TRGT_ID, 
		SH.SNDNG_DT,
		PST.SRVY_ID,
		CUSTCO.GEN_DECRYPT(PST.CUST_NM, #{PP_KEY_PP}, #{PP_ALG_PP}) AS CUST_NM,
		CUSTCO.GEN_DECRYPT(PST.CUST_PHN_NO, #{PP_KEY_PP}, #{PP_ALG_PP}) AS CUST_PHN_NO,
		CUSTCO.GEN_DECRYPT(PST.EML, #{PP_KEY_PP}, #{PP_ALG_PP}) AS EML
	FROM SNDNG_HSTRY SH 
	INNER JOIN PLT_SRVY_TRGT PST 
		ON PST.SRVY_TRGT_ID = SH.SRVY_TRGT_ID
	INNER JOIN PLT_SRVY PS 
		ON PS.SRVY_ID = PST.SRVY_ID AND PS.CUSTCO_ID=#{CUSTCO_ID}::INTEGER
	WHERE 
		PS.DEL_YN = 'N'
		AND PST.DEL_YN = 'N'
		AND PST.SRVY_ID = #{SRVY_ID}::INTEGER
		<if test="SNDNG_SE_CD != null and SNDNG_SE_CD != ''">
			<choose>
				<when test='SNDNG_SE_CD == "SMS"'>
					AND SH.SNDNG_SE_CD IN ('SMS','LMS','MMS')
				</when>
				<otherwise>
					AND SH.SNDNG_SE_CD 	= #{SNDNG_SE_CD}
				</otherwise>
			</choose>
		</if>
	</select>
	
	
	<select id="selectSendTypeStat" parameterType="java.util.HashMap" resultType="java.util.HashMap">
		WITH SNDNG_HSTRY AS ( /*	selectSendTypeStat - 설문조사 발송 유형별 현황 통계 조회 */
			SELECT 
				MTS_SNDNG_HSTRY_ID AS SNDNG_ID, 
				(CASE WHEN PMSH.SNDNG_SE_CD IN('SMS','LMS','MMS') THEN 'SMS' ELSE PMSH.SNDNG_SE_CD END) SNDNG_SE_CD, 
				PMSH.SRVY_TRGT_ID, 
				PMSH.SNDNG_DT 
			FROM PLT_MTS_SNDNG_HSTRY PMSH
			WHERE SNDNG_DT IS NOT NULL AND PMSH.SRVY_TRGT_ID IS NOT NULL AND PMSH.CUSTCO_ID = #{CUSTCO_ID}::INTEGER
			UNION
			SELECT EML_SNDNG_ID AS SNDNG_ID, 'EMAIL' AS SNDNG_SE_CD , PESH.SRVY_TRGT_ID, PESH.SNDNG_DT 
			FROM PLT_EML_SNDNG_HSTRY PESH
			WHERE SNDNG_DT IS NOT NULL AND PESH.SRVY_TRGT_ID IS NOT NULL AND PESH.CUSTCO_ID = #{CUSTCO_ID}::INTEGER
		) 
		SELECT
			SNDNG_SE_CD,
			COUNT(*) SEND_COUNT,
			(CASE WHEN SH.SNDNG_SE_CD = 'ATALK' THEN '#f9e200' WHEN SH.SNDNG_SE_CD = 'SMS' THEN '#1dcfbf' WHEN SH.SNDNG_SE_CD = 'EMAIL' THEN '#f26161' END) AS COLOR
		FROM SNDNG_HSTRY SH 
		INNER JOIN PLT_SRVY_TRGT PST 
			ON PST.SRVY_TRGT_ID = SH.SRVY_TRGT_ID
		INNER JOIN PLT_SRVY PS
			ON PS.SRVY_ID = PST.SRVY_ID AND PS.CUSTCO_ID=#{CUSTCO_ID}::INTEGER
		WHERE 
			PS.DEL_YN = 'N'
			AND PST.DEL_YN = 'N'
			AND PST.SRVY_ID = #{SRVY_ID}::INTEGER
		GROUP BY SNDNG_SE_CD
	</select>
	
	<select id="selectRspnsStat" parameterType="java.util.HashMap" resultType="java.util.HashMap">
		SELECT /*	selectRspnsStat - 참여율 현황 통계 조회 */
			COUNT(*) TOT_COUNT,
			SUM(CASE WHEN PST.SRVY_RSPNS_DT IS NOT NULL THEN 1 ELSE 0 END) RSPNS_COUNT,
			SUM(CASE WHEN PST.SRVY_RSPNS_DT IS NULL THEN 1 ELSE 0 END) NOT_RSPNS_COUNT,
			ROUND(((SUM(CASE WHEN PST.SRVY_RSPNS_DT IS NOT NULL THEN 1 ELSE 0 END)::NUMERIC / COUNT(*)::NUMERIC) * 100.0::NUMERIC)::NUMERIC, 2) RSPNS_RATE,
			ROUND(((SUM(CASE WHEN PST.SRVY_RSPNS_DT IS NULL THEN 1 ELSE 0 END)::NUMERIC / COUNT(*)::NUMERIC) * 100.0::NUMERIC)::NUMERIC, 2) NOT_RSPNS_RATE
		FROM PLT_SRVY_TRGT PST 
		INNER JOIN PLT_SRVY PS 
			ON PS.SRVY_ID = PST.SRVY_ID AND PS.CUSTCO_ID=#{CUSTCO_ID}::INTEGER
		WHERE 
			PS.DEL_YN='N'
			AND PST.DEL_YN='N'
			AND PST.SRVY_ID=#{SRVY_ID}::INTEGER
	</select>
	
	
	<select id="selectSendStat" parameterType="java.util.HashMap" resultType="java.util.HashMap">
		WITH SNDNG_HSTRY AS ( /*	selectSendStat - 발송 유형별 현황 통계 조회 */
			SELECT MTS_SNDNG_HSTRY_ID AS SNDNG_ID, SNDNG_SE_CD, PMSH.SRVY_TRGT_ID, PMSH.SNDNG_DT 
			FROM PLT_MTS_SNDNG_HSTRY PMSH
			WHERE SNDNG_DT IS NOT NULL AND PMSH.SRVY_TRGT_ID IS NOT NULL AND PMSH.CUSTCO_ID = #{CUSTCO_ID}::INTEGER
			UNION
			SELECT EML_SNDNG_ID AS SNDNG_ID, 'EMAIL' AS SNDNG_SE_CD, PESH.SRVY_TRGT_ID, PESH.SNDNG_DT 
			FROM PLT_EML_SNDNG_HSTRY PESH
			WHERE SNDNG_DT IS NOT NULL AND PESH.SRVY_TRGT_ID IS NOT NULL AND PESH.CUSTCO_ID = #{CUSTCO_ID}::INTEGER
		) 	
		SELECT
			(CASE WHEN PSH.SNDNG_SE_CD = 'ATALK' THEN 1 WHEN PSH.SNDNG_SE_CD IN('SMS','LMS','MMS') THEN 2 WHEN PSH.SNDNG_SE_CD = 'EMAIL' THEN 3 ELSE 999 END) AS SORT_ORD, 
			(CASE WHEN PSH.SNDNG_SE_CD IN('SMS','LMS','MMS') THEN 'SMS' ELSE PSH.SNDNG_SE_CD END) SNDNG_SE_CD, 
			(CASE WHEN PSH.SNDNG_SE_CD = 'ATALK' THEN '#f9e200' WHEN PSH.SNDNG_SE_CD IN('SMS','LMS','MMS') THEN '#1dcfbf' WHEN PSH.SNDNG_SE_CD = 'EMAIL' THEN '#f26161' END) AS COLOR, 
			COUNT(PSH.SNDNG_SE_CD) AS SEND_COUNT, 
			SUM(CASE WHEN PST.SRVY_RSPNS_DT IS NOT NULL THEN 1 ELSE 0 END) AS RSPNS_COUNT,
			((SUM(CASE WHEN PST.SRVY_RSPNS_DT IS NOT NULL THEN 1 ELSE 0 end)::float / COUNT(PSH.SNDNG_SE_CD)::float) * 100.0::float)::float ENGAGEMENT_RATE
		FROM PLT_SRVY_TRGT PST
		LEFT OUTER JOIN (
			SELECT SH.SRVY_TRGT_ID, SH.SNDNG_SE_CD 
			FROM SNDNG_HSTRY SH
			LEFT JOIN (
				SELECT SRVY_TRGT_ID, MAX(SNDNG_DT) AS SNDNG_DT
				FROM SNDNG_HSTRY
				GROUP BY SRVY_TRGT_ID) SH2 ON SH2.SRVY_TRGT_ID = SH.SRVY_TRGT_ID
			WHERE SH.SNDNG_DT = SH2.SNDNG_DT
		) PSH ON PSH.SRVY_TRGT_ID = PST.SRVY_TRGT_ID
		WHERE
			PST.DEL_YN = 'N'
			AND PST.SRVY_ID = #{SRVY_ID}::INTEGER
			AND PSH.SNDNG_SE_CD IS NOT NULL
		GROUP BY PSH.SNDNG_SE_CD
		ORDER BY SORT_ORD
	</select>
</mapper>