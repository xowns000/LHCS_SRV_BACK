<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
 
<mapper namespace="kr.co.hkcloud.palette3.chat.status.dao.ChatStatusAgentMapper">

<!-- 상담사대시보드 조회 -->
<select id="selectRtnAgentDashboard"  parameterType= "java.util.HashMap" resultType="java.util.HashMap">
<![CDATA[
   SELECT TO_CHAR(SYSDATE,'YYYY-MM-DD HH24:MI:SS')  AS SELECT_TIME                 -- 새로고침
        , SUM(RE.AGENT_ALL_CNT)                     AS AGENT_ALL_CNT               -- 전체
        , SUM(RE.ACTIVE_ACCOUNT_CNT)                AS ACTIVE_ACCOUNT_CNT          -- 활성계정
        , SUM(RE.AGENT_LOGGING_IN_CNT)              AS AGENT_LOGGING_IN_CNT        -- 로그인
        , SUM(RE.AGENT_READY_CNT)                   AS AGENT_READY_CNT             -- 대기
        , SUM(RE.AGENT_IN_CONSULTATION_CNT)         AS AGENT_IN_CONSULTATION_CNT   -- 상담
        , SUM(RE.AGENT_AWAY_CNT)                    AS AGENT_AWAY_CNT              -- 이석
        , SUM(RE.AGENT_LOGOUT_CNT)                  AS AGENT_LOGOUT_CNT            -- 로그아웃
     FROM (/* 전체 */
           SELECT AAL.AGENT_ALL_CNT
                , AAL.ACTIVE_ACCOUNT_CNT
                , AAL.AGENT_LOGGING_IN_CNT
                , AAL.AGENT_IN_CONSULTATION_CNT
                , AAL.AGENT_AWAY_CNT
                , AAL.AGENT_LOGOUT_CNT
                , AAL.AGENT_READY_CNT
             FROM (SELECT COUNT(*)  AS AGENT_ALL_CNT 
                        , 0         AS ACTIVE_ACCOUNT_CNT
                        , 0         AS AGENT_LOGGING_IN_CNT
                        , 0         AS AGENT_IN_CONSULTATION_CNT
                        , 0         AS AGENT_AWAY_CNT
                        , 0         AS AGENT_LOGOUT_CNT
                        , 0         AS AGENT_READY_CNT
                     FROM PLT_USER  TB01
                    WHERE TB01.CUSTCO_ID LIKE ('%'||#{ASP_NEWCUST_KEY}||'%')
                      AND TB01.USE_YN = 'Y'
                )  AAL
           UNION
           /* 활성계정 */
           SELECT ACT.AGENT_ALL_CNT
                , ACT.ACTIVE_ACCOUNT_CNT
                , ACT.AGENT_LOGGING_IN_CNT
                , ACT.AGENT_IN_CONSULTATION_CNT
                , ACT.AGENT_AWAY_CNT
                , ACT.AGENT_LOGOUT_CNT
                , ACT.AGENT_READY_CNT
             FROM (SELECT 0                           AS AGENT_ALL_CNT 
                        , SUM(AA.ACTIVE_ACCOUNT_NUM)  AS ACTIVE_ACCOUNT_CNT
                        , 0                           AS AGENT_LOGGING_IN_CNT
                        , 0                           AS AGENT_IN_CONSULTATION_CNT
                        , 0                           AS AGENT_AWAY_CNT
                        , 0                           AS AGENT_LOGOUT_CNT
                        , 0                           AS AGENT_READY_CNT
                    FROM (SELECT (SELECT (CASE WHEN LISTAGG(CASE WHEN TB07.ATRT_GROUP_ID IN ('20151106173043466TWB14896'
                                                                                            ,'20190327140137132TWB3843'
                                                                                            ,'20190503054503024TWB168613')
                                                                 THEN 'Y'
                                                                 ELSE 'N'
                                                            END) WITHIN GROUP (ORDER BY TB07.ATRT_GROUP_ID) LIKE '%Y%'
                                               THEN 1
                                               ELSE 0
                                          END) 
                                    FROM PLT_USER_AUTH TB07
                                   WHERE TB07.USER_ID = TB01.USER_ID)  AS ACTIVE_ACCOUNT_NUM
                            FROM PLT_USER  TB01
                           WHERE TB01.CUSTCO_ID LIKE ('%'||#{ASP_NEWCUST_KEY}||'%')
                             AND TB01.USE_YN = 'Y'
                         )  AA
                )  ACT
           UNION
           /* 로그인 */
           SELECT LGI.AGENT_ALL_CNT
                , LGI.ACTIVE_ACCOUNT_CNT
                , LGI.AGENT_LOGGING_IN_CNT
                , LGI.AGENT_IN_CONSULTATION_CNT
                , LGI.AGENT_AWAY_CNT
                , LGI.AGENT_LOGOUT_CNT
                , LGI.AGENT_READY_CNT
             FROM (SELECT 0                  AS AGENT_ALL_CNT 
                        , 0                  AS ACTIVE_ACCOUNT_CNT
                        , AA.LOGGING_IN_CNT  AS AGENT_LOGGING_IN_CNT
                        , 0                  AS AGENT_IN_CONSULTATION_CNT
                        , 0                  AS AGENT_AWAY_CNT
                        , 0                  AS AGENT_LOGOUT_CNT
                        , 0                  AS AGENT_READY_CNT
                    FROM (SELECT COUNT(*)    AS LOGGING_IN_CNT
                            FROM PLT_USER  TB01
                           WHERE TB01.CUSTCO_ID LIKE ('%'||#{ASP_NEWCUST_KEY}||'%')
                             AND TB01.USE_YN = 'Y'
                             AND TB01.PSNT_LOGIN_YN = 'Y'
--                             AND TB01.IT_PROCESSING BETWEEN TO_DATE(CONCAT(TO_CHAR(SYSDATE, 'YYYYMMDD'), '000000'), 'YYYYMMDDHH24MISS')
--                                                        AND TO_DATE(CONCAT(TO_CHAR(SYSDATE, 'YYYYMMDD'), '235959'), 'YYYYMMDDHH24MISS')
                         )  AA
                )  LGI
           UNION
           /* 상담 : 채팅ON 이고 (대기/상담)이 1건 이상  */
           SELECT CST.AGENT_ALL_CNT
                , CST.ACTIVE_ACCOUNT_CNT
                , CST.AGENT_LOGGING_IN_CNT
                , CST.AGENT_IN_CONSULTATION_CNT
                , CST.AGENT_AWAY_CNT
                , CST.AGENT_LOGOUT_CNT
                , CST.AGENT_READY_CNT
             FROM (SELECT 0                       AS AGENT_ALL_CNT 
                        , 0                       AS ACTIVE_ACCOUNT_CNT
                        , 0                       AS AGENT_LOGGING_IN_CNT
                        , AA.IN_CONSULTATION_CNT  AS AGENT_IN_CONSULTATION_CNT
                        , 0                       AS AGENT_AWAY_CNT
                        , 0                       AS AGENT_LOGOUT_CNT
                        , 0                       AS AGENT_READY_CNT
                    FROM (
                            SELECT COUNT(*)       AS   IN_CONSULTATION_CNT
                              FROM (
                                    /* 채팅ON 상태의 상담사별 건수 */
                                    SELECT TR.USER_ID
                                         , COALESCE(TCC.CNT, 0) AS READY_CNT
                                      FROM PLT_CHT_RDY TR
                                      LEFT JOIN (
                                                /* 상담사별 대기/상담중인 건 */
                                                SELECT USER_ID
                                                     , SUM(CNT) AS CNT
                                                  FROM (
                                                        /* 상담사별 배분대기중인 건 */
                                                        SELECT USER_ID, COUNT(1) AS CNT
                                                          FROM PLT_CHT_USER_RDY
                                                         WHERE CUSTCO_ID LIKE ('%'||#{ASP_NEWCUST_KEY}||'%')
                                                           AND TALK_READY_CD IN ('11','13')
--                                                           AND REG_DTTM BETWEEN TO_DATE(CONCAT(TO_CHAR(SYSDATE, 'YYYYMMDD'), '000000'), 'YYYYMMDDHH24MISS')
--                                                                            AND TO_DATE(CONCAT(TO_CHAR(SYSDATE, 'YYYYMMDD'), '235959'), 'YYYYMMDDHH24MISS')
                                                         GROUP BY USER_ID
                                                        UNION ALL
                                                        /* 상담사별 상담중인 건 */
                                                        SELECT USER_ID, COUNT(1) AS CNT
                                                          FROM PLT_CHT_CUTT
                                                         WHERE CUSTCO_ID LIKE ('%'||#{ASP_NEWCUST_KEY}||'%')
                                                           AND TALK_STAT_CD IN ('12', '20')
--                                                           AND REG_DTTM BETWEEN TO_DATE(CONCAT(TO_CHAR(SYSDATE, 'YYYYMMDD'), '000000'), 'YYYYMMDDHH24MISS')
--                                                                            AND TO_DATE(CONCAT(TO_CHAR(SYSDATE, 'YYYYMMDD'), '235959'), 'YYYYMMDDHH24MISS')
                                                         GROUP BY USER_ID
                                                       )
                                                 GROUP BY USER_ID
                                                )  TCC
                                        ON TR.USER_ID = TCC.USER_ID
                                     WHERE TR.CUSTCO_ID LIKE ('%'||#{ASP_NEWCUST_KEY}||'%')
--                                       AND TR.TALK_START_DT BETWEEN TO_CHAR(TO_DATE(CONCAT(TO_CHAR(SYSDATE, 'YYYYMMDD'), '000000'), 'YYYYMMDDHH24MISS'), 'YYYYMMDDHH24MISS')
--                                                                AND TO_CHAR(TO_DATE(CONCAT(TO_CHAR(SYSDATE, 'YYYYMMDD'), '235959'), 'YYYYMMDDHH24MISS'), 'YYYYMMDDHH24MISS')
                                   )
                             WHERE READY_CNT > 0
                         )  AA
                )  CST
           UNION
           /* 이석 : 이석상태(점심,교육,회의,휴식) 이고 (대기/상담)이 0건 */
           SELECT AWY.AGENT_ALL_CNT
                , AWY.ACTIVE_ACCOUNT_CNT
                , AWY.AGENT_LOGGING_IN_CNT
                , AWY.AGENT_IN_CONSULTATION_CNT
                , AWY.AGENT_AWAY_CNT
                , AWY.AGENT_LOGOUT_CNT
                , AWY.AGENT_READY_CNT
             FROM (SELECT 0                          AS AGENT_ALL_CNT 
                        , 0                          AS ACTIVE_ACCOUNT_CNT
                        , 0                          AS AGENT_LOGGING_IN_CNT
                        , 0                          AS AGENT_IN_CONSULTATION_CNT
                        , AA.AGENT_AWAY_CNT          AS AGENT_AWAY_CNT
                        , 0                          AS AGENT_LOGOUT_CNT
                        , 0                          AS AGENT_READY_CNT
                    FROM (
                            SELECT COUNT(*)       AS   AGENT_AWAY_CNT
                              FROM (
                                    /* 추가작업 상태의 상담사별 건수 */
                                    SELECT ROF.USER_ID
                                         , COALESCE(TCC.CNT, 0) AS AWAY_CNT
                                      FROM PLT_CHT_RDY_ONF  ROF
                                      LEFT JOIN (
                                                /* 상담사별 대기/상담중인 건 */
                                                SELECT USER_ID
                                                     , SUM(CNT) AS CNT
                                                  FROM (
                                                        /* 상담사별 배분대기중인 건 */
                                                        SELECT USER_ID, COUNT(1) AS CNT
                                                          FROM PLT_CHT_USER_RDY
                                                         WHERE CUSTCO_ID LIKE ('%'||#{ASP_NEWCUST_KEY}||'%')
                                                           AND TALK_READY_CD IN ('11','13')
                                                           AND REG_DTTM BETWEEN TO_DATE(CONCAT(TO_CHAR(SYSDATE, 'YYYYMMDD'), '000000'), 'YYYYMMDDHH24MISS')
                                                                            AND TO_DATE(CONCAT(TO_CHAR(SYSDATE, 'YYYYMMDD'), '235959'), 'YYYYMMDDHH24MISS')
                                                         GROUP BY USER_ID
                                                        UNION ALL
                                                        /* 상담사별 상담중인 건 */
                                                        SELECT USER_ID, COUNT(1) AS CNT
                                                          FROM PLT_CHT_CUTT
                                                         WHERE CUSTCO_ID LIKE ('%'||#{ASP_NEWCUST_KEY}||'%')
                                                           AND TALK_STAT_CD IN ('12', '20')
                                                           AND REG_DTTM BETWEEN TO_DATE(CONCAT(TO_CHAR(SYSDATE, 'YYYYMMDD'), '000000'), 'YYYYMMDDHH24MISS')
                                                                            AND TO_DATE(CONCAT(TO_CHAR(SYSDATE, 'YYYYMMDD'), '235959'), 'YYYYMMDDHH24MISS')
                                                         GROUP BY USER_ID
                                                       )
                                                 GROUP BY USER_ID
                                                )  TCC
                                        ON ROF.USER_ID = TCC.USER_ID
                                     WHERE ROF.CUSTCO_ID LIKE ('%'||#{ASP_NEWCUST_KEY}||'%')
                                       AND ROF.USER_STATUS_CD IN ('EDU','MEAL','MEETING','REST','CHATOFF','ADDWORK','STOMPOFF')	/* 교육,점심,회의,휴식,채팅OFF,추가작업,자동채팅OFF */
                                       AND ROF.TALK_START_DT   BETWEEN TO_DATE(CONCAT(TO_CHAR(SYSDATE, 'YYYYMMDD'), '000000'), 'YYYYMMDDHH24MISS')
                                                                   AND TO_DATE(CONCAT(TO_CHAR(SYSDATE, 'YYYYMMDD'), '235959'), 'YYYYMMDDHH24MISS')
                                   )
                             WHERE AWAY_CNT = 0
                         )  AA
                )  AWY
           UNION
           /* 로그아웃 */
           SELECT LGO.AGENT_ALL_CNT
                , LGO.ACTIVE_ACCOUNT_CNT
                , LGO.AGENT_LOGGING_IN_CNT
                , LGO.AGENT_IN_CONSULTATION_CNT
                , LGO.AGENT_AWAY_CNT
                , LGO.AGENT_LOGOUT_CNT
                , LGO.AGENT_READY_CNT
             FROM (SELECT 0                          AS AGENT_ALL_CNT 
                        , 0                          AS ACTIVE_ACCOUNT_CNT
                        , 0                          AS AGENT_LOGGING_IN_CNT
                        , 0                          AS AGENT_IN_CONSULTATION_CNT
                        , 0                          AS AGENT_AWAY_CNT
                        , AA.LOGOUT_CNT              AS AGENT_LOGOUT_CNT
                        , 0                          AS AGENT_READY_CNT
                    FROM (SELECT COUNT(*)            AS LOGOUT_CNT
                            FROM PLT_USER  TB01
                           WHERE TB01.CUSTCO_ID LIKE ('%'||#{ASP_NEWCUST_KEY}||'%')
                             AND TB01.USE_YN = 'Y'
                             AND TB01.PSNT_LOGIN_YN = 'N'
                         )  AA
                )  LGO
           UNION
           /* 대기 : 채팅ON 이고 (대기/상담)이 0건 */
           SELECT RDY.AGENT_ALL_CNT
                , RDY.ACTIVE_ACCOUNT_CNT
                , RDY.AGENT_LOGGING_IN_CNT
                , RDY.AGENT_IN_CONSULTATION_CNT
                , RDY.AGENT_AWAY_CNT
                , RDY.AGENT_LOGOUT_CNT
                , RDY.AGENT_READY_CNT
             FROM (SELECT 0                          AS AGENT_ALL_CNT 
                        , 0                          AS ACTIVE_ACCOUNT_CNT
                        , 0                          AS AGENT_LOGGING_IN_CNT
                        , 0                          AS AGENT_IN_CONSULTATION_CNT
                        , 0                          AS AGENT_AWAY_CNT
                        , 0                          AS AGENT_LOGOUT_CNT
                        , AA.AGENT_READY_CNT         AS AGENT_READY_CNT
                    FROM (
                            SELECT COUNT(*)       AS   AGENT_READY_CNT
                              FROM (
                                    /* 채팅ON 상태의 상담사별 건수 */
                                    SELECT TR.USER_ID
                                         , COALESCE(TCC.CNT, 0) AS READY_CNT
                                      FROM PLT_CHT_RDY TR
                                      LEFT JOIN (
                                                /* 상담사별 대기/상담중인 건 */
                                                SELECT USER_ID
                                                     , SUM(CNT) AS CNT
                                                  FROM (
                                                        /* 상담사별 배분대기중인 건 */
                                                        SELECT USER_ID, COUNT(1) AS CNT
                                                          FROM PLT_CHT_USER_RDY
                                                         WHERE CUSTCO_ID LIKE ('%'||#{ASP_NEWCUST_KEY}||'%')
                                                           AND TALK_READY_CD IN ('11','13')
--                                                           AND REG_DTTM BETWEEN TO_DATE(CONCAT(TO_CHAR(SYSDATE, 'YYYYMMDD'), '000000'), 'YYYYMMDDHH24MISS')
--                                                                            AND TO_DATE(CONCAT(TO_CHAR(SYSDATE, 'YYYYMMDD'), '235959'), 'YYYYMMDDHH24MISS')
                                                         GROUP BY USER_ID
                                                        UNION ALL
                                                        /* 상담사별 상담중인 건 */
                                                        SELECT USER_ID, COUNT(1) AS CNT
                                                          FROM PLT_CHT_CUTT
                                                         WHERE CUSTCO_ID LIKE ('%'||#{ASP_NEWCUST_KEY}||'%')
                                                           AND TALK_STAT_CD IN ('12', '20')
--                                                           AND REG_DTTM BETWEEN TO_DATE(CONCAT(TO_CHAR(SYSDATE, 'YYYYMMDD'), '000000'), 'YYYYMMDDHH24MISS')
--                                                                            AND TO_DATE(CONCAT(TO_CHAR(SYSDATE, 'YYYYMMDD'), '235959'), 'YYYYMMDDHH24MISS')
                                                         GROUP BY USER_ID
                                                       )
                                                 GROUP BY USER_ID
                                                )  TCC
                                        ON TR.USER_ID = TCC.USER_ID
                                     WHERE TR.CUSTCO_ID LIKE ('%'||#{ASP_NEWCUST_KEY}||'%')
--                                       AND TR.TALK_START_DT BETWEEN TO_CHAR(TO_DATE(CONCAT(TO_CHAR(SYSDATE, 'YYYYMMDD'), '000000'), 'YYYYMMDDHH24MISS'), 'YYYYMMDDHH24MISS')
--                                                                AND TO_CHAR(TO_DATE(CONCAT(TO_CHAR(SYSDATE, 'YYYYMMDD'), '235959'), 'YYYYMMDDHH24MISS'), 'YYYYMMDDHH24MISS')
                                   )
                             WHERE READY_CNT = 0
                         )  AA
                )  RDY
     )  RE
 GROUP BY 1
]]>
</select>


<!-- 상담사모니터링현황 조회 -->
<select id="selectRtnAgentMonitoringStatus"  parameterType= "java.util.HashMap" resultType="java.util.HashMap">
<![CDATA[
	SELECT		/* selectRtnAgentMonitoringStatus - 채팅 모니터링 상담사 현황 조회 */
		ROW_NUMBER() OVER(ORDER BY PCCPS.CUSL_ID) AS ROWNUM
		, PCCPS.CUSL_ID
		, PU.USER_NM
		, PU.LGN_ID
		, PU.ICON
		, (SELECT array_to_string(array_agg( FILE_PATH || '/' || STRG_FILE_NM ), '')
			FROM PLT_FILE
			WHERE FILE_GROUP_KEY = PU.ICON)	AS ICON_IMG_URI
		, PPIE.EXT_NO
		, PCCPS.CHT_LMT_CNT
		, (CASE WHEN PCCR.CUSL_ID = PCCPS.CUSL_ID THEN 'CHT_WAIT' ELSE 'CHT_CANT' END) AS CHT_STAT
		, (CASE WHEN PCCR.CUSL_ID = PCCPS.CUSL_ID THEN PCCR.CUTT_BGNG_DT ELSE '0' END) AS CHT_STAT_DT
		, LOG.TASK_SE_CD	AS LGN_STTS
		, LOG.REG_DT		AS LGN_STTS_DT
		, (CASE WHEN (SELECT COUNT(CHT_CUTT_ID)
						FROM PLT_CHT_CUTT
						WHERE CUSL_ID = PCCPS.CUSL_ID
							AND CUTT_STTS_CD = 'ING') > 0
			THEN 'ING' 
			ELSE '0'
			END)	AS CUTT_STTS_CD
		, (CASE WHEN (SELECT COUNT(CHT_CUTT_ID)
						FROM PLT_CHT_CUTT
						WHERE CUSL_ID = PCCPS.CUSL_ID
							AND CUTT_STTS_CD = 'ING') > 0
			THEN CUTT_BGNG_DT
			ELSE '0'
			END)	AS CUTT_STTS_CD_DT
		, (SELECT COUNT(CHT_CUTT_ID)
			FROM PLT_CHT_CUTT
			WHERE CUSL_ID = PCCPS.CUSL_ID
			AND CUTT_STTS_CD LIKE ('%'||'CMPL'||'%'))	AS CMPL_CNT
		, (SELECT COUNT(CHT_CUTT_ID)
			FROM PLT_CHT_CUTT
			WHERE CUSL_ID = PCCPS.CUSL_ID)	AS TOT_CNT
		, (SELECT COUNT(CHT_CUTT_ID)
			FROM PLT_CHT_CUTT
			WHERE CUSL_ID = PCCPS.CUSL_ID
			AND CUTT_STTS_CD IN ('WAIT','ING','TRAN_WAIT','CLBK_WAIT'))	AS ALTMNT_CNT
		, (SELECT COUNT(CHT_CUTT_ID)
			FROM PLT_CHT_CUTT
			WHERE CUSL_ID = PCCPS.CUSL_ID
			AND CUTT_STTS_CD = 'ING')	AS ING_CNT
		, (SELECT COUNT(CHT_CUTT_ID)
			FROM PLT_CHT_CUTT
			WHERE CUSL_ID = PCCPS.CUSL_ID
			AND CUTT_STTS_CD IN ('AFTPRCS','AFTPRCS_NORSPNS'))	AS AFTPRCS_CNT
		, (SELECT TO_CHAR(SUM(CASE WHEN CUTT_BGNG_DT IS NOT NULL
									AND CUTT_END_DT IS NOT NULL
								THEN TO_TIMESTAMP(CUTT_END_DT,'YYYYMMDDHH24MISS')-TO_TIMESTAMP(CUTT_BGNG_DT,'YYYYMMDDHH24MISS') 
								ELSE '0' END
								),'YYYYMMDDHH24MISS')
			FROM PLT_CHT_CUTT
			WHERE CUSL_ID = PCCPS.CUSL_ID)	AS CHT_TIME
		, (SELECT TO_CHAR(AVG(CASE WHEN CUTT_BGNG_DT IS NOT NULL
									AND CUTT_END_DT IS NOT NULL
								THEN TO_TIMESTAMP(CUTT_END_DT,'YYYYMMDDHH24MISS')-TO_TIMESTAMP(CUTT_BGNG_DT,'YYYYMMDDHH24MISS') 
								ELSE '0' END
								),'YYYYMMDDHH24MISS')
			FROM PLT_CHT_CUTT
			WHERE CUSL_ID = PCCPS.CUSL_ID)	AS AVG_CHT_TIME
		, '00000000000000' AS REST_TIME/*이석시간 추후 추가*/
		, '00000000000000' AS AVG_REST_TIME/*이석시간 추후 추가*/
		, (SELECT TO_CHAR(SUM(CASE WHEN CUTT_STTS_CD LIKE ('%'||'CMPL'||'%')
								THEN TO_TIMESTAMP(CUTT_HSTRY_REG_DT,'YYYYMMDDHH24MISS')-TO_TIMESTAMP(CUTT_END_DT,'YYYYMMDDHH24MISS') 
								ELSE '0' END
								),'YYYYMMDDHH24MISS')
			FROM PLT_CHT_CUTT
			WHERE CUSL_ID = PCCPS.CUSL_ID)	AS AFTPRCS_TIME
		, (SELECT TO_CHAR(AVG(CASE WHEN CUTT_STTS_CD LIKE ('%'||'CMPL'||'%')
								THEN TO_TIMESTAMP(CUTT_HSTRY_REG_DT,'YYYYMMDDHH24MISS')-TO_TIMESTAMP(CUTT_END_DT,'YYYYMMDDHH24MISS') 
								ELSE '0' END
								),'YYYYMMDDHH24MISS')
			FROM PLT_CHT_CUTT
			WHERE CUSL_ID = PCCPS.CUSL_ID)	AS AVG_AFTPRCS_TIME
	FROM PLT_CHT_CUTT_PM_STNG PCCPS
	INNER JOIN PLT_USER PU ON PU.USER_ID = PCCPS.CUSL_ID
	LEFT JOIN PLT_CHT_CUTT_RDY PCCR
		ON PCCR.CUSL_ID = PCCPS.CUSL_ID
	LEFT JOIN (SELECT PUL.USER_ID
			     , PUL.TASK_SE_CD
			     , PUL.REG_DT
				FROM PLT_USER_LOG PUL
				INNER JOIN (
				    SELECT USER_ID, MAX(REG_DT) AS MAX_REG_DT
				    FROM PLT_USER_LOG
				    GROUP BY USER_ID
				) PUL_MAX ON PUL.USER_ID = PUL_MAX.USER_ID AND PUL.REG_DT = PUL_MAX.MAX_REG_DT) LOG
		ON LOG.USER_ID = PCCPS.CUSL_ID
	LEFT OUTER JOIN PLT_PHN_IP_EXT PPIE ON PPIE.USER_ID = PCCPS.CUSL_ID
]]>
	WHERE PU.USER_STTS_CD = 'WORK'
	AND LOG.TASK_SE_CD IS NOT NULL
	AND EXISTS (SELECT 1 FROM PLT_USER_OGNZ PUO WHERE PUO.USER_ID = PU.USER_ID AND PUO.CUSTCO_ID = #{CUSTCO_ID} AND PUO.USE_YN = 'Y')
		<if test="USER_SRCH != '' and USER_SRCH != null and USER_SRCH != undefined">
			AND PCCPS.CUSL_ID IN (SELECT USER_ID
									FROM PLT_USER
									WHERE LGN_ID LIKE ('%'||#{USER_SRCH}||'%')
									OR USER_NM LIKE ('%'||#{USER_SRCH}||'%'))
		</if>
		<choose>
			<when test="SRCH_TY == 'LOGIN' or SRCH_TY == 'LOGOUT'">
				AND LOG.TASK_SE_CD = #{SRCH_TY}
			</when>
			<when test="SRCH_TY == 'WAIT'">
				AND PCCPS.CUSL_ID = PCCR.CUSL_ID
			</when>
			<when test="SRCH_TY == 'ING'">
				AND PCCPS.CUSL_ID IN (CASE WHEN (SELECT COUNT(CHT_CUTT_ID)
												FROM PLT_CHT_CUTT
												WHERE CUSL_ID = PCCPS.CUSL_ID
													AND CUTT_STTS_CD = 'ING') > 0
										THEN PCCPS.CUSL_ID
										ELSE '0'
										END)
			</when>
			<when test="SRCH_TY == 'REST'">
				/*추후 개발*/
			</when>
		</choose>
	<if test='STTS_EXPSR_MTHD_CD != null and STTS_EXPSR_MTHD_CD != ""'>
		AND (PU.STTS_EXPSR_MTHD_CD IS NULL OR PU.STTS_EXPSR_MTHD_CD = '' OR PU.STTS_EXPSR_MTHD_CD = #{STTS_EXPSR_MTHD_CD})
	</if>
	ORDER BY ROWNUM
</select>


<!-- sns상담현황 조회 -->
<select id="selectChnStts"  parameterType= "java.util.HashMap" resultType="java.util.HashMap">
<![CDATA[
	SELECT		/* selectChnStts - 홈화면 SNS상담현황 조회 */
		PCCD.CD_ID
		, PCCD.CD_NM
		, PCCD.CD_VL
		, SUM(CASE WHEN TO_TIMESTAMP(PCC.ALTMNT_RDY_REG_DT,'YYYYMMDDHH24MISS') >= TRUNC(SYSDATE) 
					AND TO_TIMESTAMP(PCC.ALTMNT_RDY_REG_DT,'YYYYMMDDHH24MISS') < TRUNC(SYSDATE) + 1
					THEN 1
					ELSE 0 END
					)	AS TODAY_CNT
		, COUNT(PCC.CHT_CUTT_ID)	AS TOT_CNT
		, SUM(CASE WHEN CUTT_STTS_CD NOT IN ('ALTMNT_GIVEUP','DMND_GIVEUP','CUSL_ALTMNT_NPSBL','DMND_NOCHC')
					THEN 1
					ELSE 0 END
					)	AS ALTMNT_CNT
		, SUM(CASE WHEN CUTT_STTS_CD LIKE ('%'||'WAIT'||'%') AND CUTT_STTS_CD != 'WAIT_GIVEUP'
					THEN 1
					ELSE 0 END
					)	AS WAIT_CNT
		, SUM(CASE WHEN CUTT_STTS_CD ='ING'
					THEN 1
					ELSE 0 END
					)	AS ING_CNT
		, SUM(CASE WHEN CUTT_STTS_CD LIKE ('%'||'AFTPRCS'||'%')
					THEN 1
					ELSE 0 END
					)	AS AFTPRCS_CNT
		, SUM(CASE WHEN CUTT_STTS_CD LIKE ('%'||'CMPL'||'%')
					THEN 1
					ELSE 0 END
					)	AS CMPL_CNT
	FROM PLT_COMM_CD PCCD
	LEFT JOIN PLT_CHT_CUTT PCC 
		ON PCC.CHN_CLSF_CD = PCCD.CD_ID 
		AND TO_TIMESTAMP(PCC.ALTMNT_RDY_REG_DT,'YYYYMMDDHH24MISS') >= TRUNC(SYSDATE, 'DAY') + 1
		AND TO_TIMESTAMP(PCC.ALTMNT_RDY_REG_DT,'YYYYMMDDHH24MISS') < TRUNC(SYSDATE, 'DAY') + 8
	WHERE PCCD.CUSTCO_ID = #{CUSTCO_ID} AND PCCD.GROUP_CD_ID = 'CHNL_CL'
	AND PCCD.USE_YN = 'Y'
	AND PCCD.DEL_YN = 'N'
	GROUP BY PCCD.CD_ID,PCCD.CD_NM,PCCD.CD_VL
]]>
</select>

<!-- 오늘의 상담 현황 / 전일대비 -->
<select id="selectSttsToday"  parameterType= "java.util.HashMap" resultType="java.util.HashMap">
<![CDATA[
	SELECT		/* SELECTSTTSTODAY - 오늘의 상담 현황, 전일대비 */
		COALESCE(TO_CHAR(SUM(
			CASE WHEN PCC.CUTT_BGNG_DT IS NOT NULL
				AND PCC.CUTT_END_DT IS NOT NULL
				AND TO_TIMESTAMP(PCC.ALTMNT_RDY_REG_DT, 'YYYYMMDDHH24MISS') >= CURRENT_DATE
      			AND TO_TIMESTAMP(PCC.ALTMNT_RDY_REG_DT, 'YYYYMMDDHH24MISS') < CURRENT_DATE + INTERVAL '1 DAY'
			THEN TO_TIMESTAMP(PCC.CUTT_END_DT,'YYYYMMDDHH24MISS')-TO_TIMESTAMP(PCC.CUTT_BGNG_DT,'YYYYMMDDHH24MISS') 
			ELSE '0' END
			),'YYYYMMDDHH24MISS'), '0')	AS TODAY_TIME
		, COALESCE(SUM(CASE WHEN TO_TIMESTAMP(PCC.ALTMNT_RDY_REG_DT, 'YYYYMMDDHH24MISS') >= CURRENT_DATE
			      AND TO_TIMESTAMP(PCC.ALTMNT_RDY_REG_DT, 'YYYYMMDDHH24MISS') < CURRENT_DATE + INTERVAL '1 DAY'
			    THEN 1
			    ELSE 0 END
				), 0)	AS TODAY_CNT
		, COALESCE(SUM(CASE WHEN TO_TIMESTAMP(PCC.ALTMNT_RDY_REG_DT, 'YYYYMMDDHH24MISS') >= CURRENT_DATE - INTERVAL '1 DAY'
				AND TO_TIMESTAMP(PCC.ALTMNT_RDY_REG_DT, 'YYYYMMDDHH24MISS') < CURRENT_DATE
			    THEN 1
			    ELSE 0 END
				), 0)	AS YESTERDAY_CNT
	FROM PLT_CHT_CUTT PCC
	WHERE PCC.CUSL_ID = #{CUSL_ID}
		AND PCC.CUSTCO_ID = #{CUSTCO_ID}
		AND (PCC.CUTT_STTS_CD LIKE ('%'||'CMPL'||'%') OR PCC.CUTT_STTS_CD LIKE ('%'||'AFTPRCS'||'%') OR PCC.CUTT_STTS_CD = 'ING')
]]>
</select>


</mapper>