<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.co.hkcloud.palette3.admin.lkag.mng.request.dao.LkagMngRequestMapper">
    <select id="selectList" parameterType= "java.util.HashMap" resultType="java.util.HashMap">
        WITH RECURSIVE LKAG_PARAMS_TREE (PARAM_ARTCL_ID, UP_ARTCL_ID, LKAG_ID, COL_NM, ARTCL_NM, DSPLY_NM, DATA_TYPE_CD, DATA_TYPE_FMT_CD
            , ESNTL_YN, ENCPT_YN, BSC_VL, EXPLN, SORT_ORD, RSPNS_ARTCL_ID, RSPNS_LKAG_ID, RSPNS_ARTCL_ID_NM
            , LVL, SORT, ARTCL_FULL_NM, FULL_PATH, PARAM_ENCPT_MTHD_CD, PARAM_ENCPT_KEY, PARAM_ENCPT_MTHD_CD_NM, PARAM_ENCPT_MTHD_CD_VL
            , DATA_TYPE_CD_NM, DATA_TYPE_CD_VL, USE_YN, LKAG_GROUP_CD_ID ) AS (
            SELECT PLPA.PARAM_ARTCL_ID, PLPA.UP_ARTCL_ID, PLPA.LKAG_ID, PLPA.COL_NM, PLPA.ARTCL_NM, PLPA.COL_NM ||'(' || PLPA.ARTCL_NM||')' as DSPLY_NM , PLPA.DATA_TYPE_CD, PLPA.DATA_TYPE_FMT_CD
                 , PLPA.ESNTL_YN, PLPA.ENCPT_YN, PLPA.BSC_VL, PLPA.EXPLN, PLPA.SORT_ORD, PLPA.RSPNS_ARTCL_ID, PLRA.LKAG_ID AS RSPNS_LKAG_ID
                , CASE WHEN PLPA.RSPNS_ARTCL_ID IS NOT NULL THEN
                    (
                        SELECT B.MST_NM ||' > '||LKAG_NM || ' > ' || PLRA.COL_NM ||'('|| PLRA.ARTCL_NM ||')'
                        FROM CUSTCO.PLT_LKAG_MNG A
                        INNER JOIN CUSTCO.PLT_LKAG_MST B ON B.LKAG_MST_ID = A.LKAG_MST_ID
                        WHERE LKAG_ID = PLRA.LKAG_ID
                    )
                    ELSE NULL
                END AS RSPNS_ARTCL_ID_NM
                 , 1 AS LVL, LPAD(CAST(PLPA.SORT_ORD AS VARCHAR),5,'0') AS SORT
                 , CAST(PLPA.ARTCL_NM AS VARCHAR(300)) AS ARTCL_FULL_NM
                 , CAST(PLPA.COL_NM AS VARCHAR(300)) AS FULL_PATH
                 , PLM.PARAM_ENCPT_MTHD_CD
                 , PLM.PARAM_ENCPT_KEY
                 , PEMC.CD_NM as PARAM_ENCPT_MTHD_CD_NM
                 , PEMC.CD_VL as PARAM_ENCPT_MTHD_CD_VL
                 , PDTC.CD_NM as DATA_TYPE_CD_NM
                 , PDTC.CD_VL as DATA_TYPE_CD_VL
                 , PLPA.USE_YN
                 , PLPA.LKAG_GROUP_CD_ID
            FROM CUSTCO.PLT_LKAG_PARAM_ARTCL PLPA
         INNER JOIN CUSTCO.PLT_LKAG_MNG PLM ON PLM.LKAG_ID = PLPA.LKAG_ID
         LEFT OUTER JOIN CUSTCO.PLT_LKAG_RSPNS_ARTCL PLRA ON PLRA.RSPNS_ARTCL_ID = PLPA.RSPNS_ARTCL_ID
         LEFT OUTER JOIN CUSTCO.PLT_COMM_CD PEMC ON PEMC.CUSTCO_ID = 1 AND PEMC.CD_ID = PLM.PARAM_ENCPT_MTHD_CD AND PEMC.GROUP_CD_ID = 'LKAG_EN_CERT_TP'
         LEFT OUTER JOIN CUSTCO.PLT_COMM_CD PDTC ON PDTC.CUSTCO_ID = 1 AND PDTC.CD_ID = PLPA.DATA_TYPE_CD AND PDTC.GROUP_CD_ID = 'LKAG_PARAM_ITEM_TP'
            WHERE PLPA.UP_ARTCL_ID IS NULL
              AND PLPA.USE_YN = 'Y' AND PLPA.DEL_YN='N'
                <choose>
                    <when test="SRCH_LKAG_ID != null and SRCH_LKAG_ID !=''">  AND PLPA.LKAG_ID = #{SRCH_LKAG_ID}::INTEGER   </when>
                    <otherwise> AND PLPA.LKAG_ID = #{LKAG_ID}::INTEGER </otherwise>
                </choose>
                <if test="SRCH_EX_LKAG_ID !='' and SRCH_EX_LKAG_ID != null"> AND PLPA.LKAG_ID <![CDATA[<>]]> #{SRCH_EX_LKAG_ID} /* 제외 */</if>
            UNION ALL
            SELECT PLPA.PARAM_ARTCL_ID, PLPA.UP_ARTCL_ID, PLPA.LKAG_ID, PLPA.COL_NM, PLPA.ARTCL_NM, PLPA.COL_NM ||'(' || PLPA.ARTCL_NM||')' as DSPLY_NM, PLPA.DATA_TYPE_CD, PLPA.DATA_TYPE_FMT_CD
                 , PLPA.ESNTL_YN, PLPA.ENCPT_YN, PLPA.BSC_VL, PLPA.EXPLN, PLPA.SORT_ORD, PLPA.RSPNS_ARTCL_ID, PLRA.LKAG_ID AS RSPNS_LKAG_ID
                , CASE WHEN PLPA.RSPNS_ARTCL_ID IS NOT NULL THEN
                    (
                        SELECT B.MST_NM ||' > '||LKAG_NM || ' > ' || PLRA.COL_NM ||'('|| PLRA.ARTCL_NM ||')'
                        FROM CUSTCO.PLT_LKAG_MNG A
                        INNER JOIN CUSTCO.PLT_LKAG_MST B ON B.LKAG_MST_ID = A.LKAG_MST_ID
                        WHERE LKAG_ID = PLRA.LKAG_ID
                    )
                    ELSE NULL
                END AS RSPNS_ARTCL_ID_NM
                 , LVL + 1, LPT.SORT || ' > ' || LPAD(CAST(PLPA.SORT_ORD AS VARCHAR),5,'0') AS SORT
                 , CAST(LPT.ARTCL_FULL_NM || ' > ' || PLPA.ARTCL_NM AS VARCHAR(300)) AS ARTCL_FULL_NM
                 , CAST(LPT.FULL_PATH || ' > ' || PLPA.COL_NM AS VARCHAR(300)) AS FULL_PATH
                 , PLM.PARAM_ENCPT_MTHD_CD
                 , PLM.PARAM_ENCPT_KEY
                 , PEMC.CD_NM as PARAM_ENCPT_MTHD_CD_NM
                 , PEMC.CD_VL as PARAM_ENCPT_MTHD_CD_VL
                 , PDTC.CD_NM as DATA_TYPE_CD_NM
                 , PDTC.CD_VL as DATA_TYPE_CD_VL
                 , PLPA.USE_YN
                 , PLPA.LKAG_GROUP_CD_ID
            FROM CUSTCO.PLT_LKAG_PARAM_ARTCL PLPA
         INNER JOIN LKAG_PARAMS_TREE LPT ON PLPA.UP_ARTCL_ID = LPT.PARAM_ARTCL_ID
         INNER JOIN CUSTCO.PLT_LKAG_MNG PLM ON PLM.LKAG_ID = PLPA.LKAG_ID
         LEFT OUTER JOIN CUSTCO.PLT_LKAG_RSPNS_ARTCL PLRA ON PLRA.RSPNS_ARTCL_ID = PLPA.RSPNS_ARTCL_ID
         LEFT OUTER JOIN CUSTCO.PLT_COMM_CD PEMC ON PEMC.CUSTCO_ID = 1 AND PEMC.CD_ID = PLM.PARAM_ENCPT_MTHD_CD AND PEMC.GROUP_CD_ID = 'LKAG_EN_CERT_TP'
         LEFT OUTER JOIN CUSTCO.PLT_COMM_CD PDTC ON PDTC.CUSTCO_ID = 1 AND PDTC.CD_ID = PLPA.DATA_TYPE_CD AND PDTC.GROUP_CD_ID = 'LKAG_PARAM_ITEM_TP'
            WHERE PLPA.UP_ARTCL_ID IS NOT NULL
              AND PLPA.USE_YN = 'Y' AND PLPA.DEL_YN='N'
                <choose>
                    <when test="SRCH_LKAG_ID != null and SRCH_LKAG_ID !=''">  AND PLPA.LKAG_ID = #{SRCH_LKAG_ID}::INTEGER   </when>
                    <otherwise> AND PLPA.LKAG_ID = #{LKAG_ID}::INTEGER </otherwise>
                </choose>
                <if test="SRCH_EX_LKAG_ID !='' and SRCH_EX_LKAG_ID != null"> AND PLPA.LKAG_ID <![CDATA[<>]]> #{SRCH_EX_LKAG_ID} /* 제외 */</if>
        )
        SELECT PARAM_ARTCL_ID, UP_ARTCL_ID, LKAG_ID, COL_NM, ARTCL_NM, DSPLY_NM, DATA_TYPE_CD, DATA_TYPE_FMT_CD
             , ESNTL_YN, ENCPT_YN, BSC_VL, EXPLN, SORT_ORD, RSPNS_ARTCL_ID, RSPNS_LKAG_ID, RSPNS_ARTCL_ID_NM
             , LVL, SORT, ARTCL_FULL_NM, FULL_PATH, replace(FULL_PATH, ' > ', '.') as FULL_PATH_DOT, PARAM_ENCPT_MTHD_CD, PARAM_ENCPT_KEY, PARAM_ENCPT_MTHD_CD_NM, PARAM_ENCPT_MTHD_CD_VL
             , DATA_TYPE_CD_NM, DATA_TYPE_CD_VL
             , USE_YN, LKAG_GROUP_CD_ID, true as COL_NM_DPCN
             , (SELECT COUNT(*) FROM CUSTCO.PLT_LKAG_PARAM_ARTCL WHERE LKAG_ID = RT.LKAG_ID AND COALESCE(UP_ARTCL_ID,-1) = COALESCE(RT.UP_ARTCL_ID,-1) AND DEL_YN = 'N') AS MAX_SORT_ORD
        FROM LKAG_PARAMS_TREE RT
        ORDER BY SORT
    </select>

    <update id="insert" parameterType="java.util.HashMap">
        INSERT  /* 연동관리 데이터전문 Request Parameter 등록 insert - kr.co.hkcloud.palette3.admin.lkag.mng.request.dao.LkagMngRequestMapper */
        INTO CUSTCO.PLT_LKAG_PARAM_ARTCL ( UP_ARTCL_ID, PARAM_ARTCL_ID, LKAG_ID, COL_NM, ARTCL_NM, DATA_TYPE_CD, DATA_TYPE_FMT_CD, LKAG_GROUP_CD_ID
                                         , ESNTL_YN, ENCPT_YN, BSC_VL, EXPLN, USE_YN, SORT_ORD, RGTR_ID, REG_DT, MDFR_ID, MDFCN_DT, DEL_YN, RSPNS_ARTCL_ID)
        VALUES ( #{UP_ARTCL_ID}::INTEGER, #{PARAM_ARTCL_ID}::INTEGER, #{LKAG_ID}::INTEGER, #{COL_NM}, #{ARTCL_NM}, #{DATA_TYPE_CD}, #{DATA_TYPE_FMT_CD}, #{LKAG_GROUP_CD_ID}
               , #{ESNTL_YN}, #{ENCPT_YN}, #{BSC_VL}, #{EXPLN}, 'Y'
               , (
                    SELECT COALESCE(COUNT(1), 0) + 1
                    FROM CUSTCO.PLT_LKAG_PARAM_ARTCL WHERE LKAG_ID = #{LKAG_ID}::INTEGER
                    <choose>
                        <when test="UP_ARTCL_ID == null or UP_ARTCL_ID ==''">
                            AND UP_ARTCL_ID IS NULL
                        </when>
                        <otherwise>
                            AND UP_ARTCL_ID=#{UP_ARTCL_ID}::INTEGER
                        </otherwise>
                    </choose>
                    )
               , #{USER_ID}::INTEGER, TO_CHAR(NOW(),'YYYYMMDDHH24MISS'), #{USER_ID}::INTEGER, TO_CHAR(NOW(),'YYYYMMDDHH24MISS'), 'N'
               ,<choose>
                    <when test="RSPNS_ARTCL_ID == null or RSPNS_ARTCL_ID ==''">NULL</when>
                    <otherwise>#{RSPNS_ARTCL_ID}::INTEGER</otherwise>
                </choose>
        )
    </update>
    <update id="update" parameterType="java.util.HashMap">
        UPDATE /* 연동관리 데이터전문 Request Parameter 수정 update - kr.co.hkcloud.palette3.admin.lkag.mng.dao.LkagMngMapper */
            CUSTCO.PLT_LKAG_PARAM_ARTCL
        SET COL_NM = #{COL_NM}, /* 파라미터_컬럼_명 */
            ARTCL_NM = #{ARTCL_NM},/* 파라미터_명 */
            DATA_TYPE_CD = #{DATA_TYPE_CD},/* 파라미터_자료_유형_코드 => LKAG_PARAM_ITEM_TP*/
            DATA_TYPE_FMT_CD = #{DATA_TYPE_FMT_CD},/* 파라미터_자료_유형_포멧_코드 => LPIT_DATETIME_FMT*/
            LKAG_GROUP_CD_ID = #{LKAG_GROUP_CD_ID},
            ESNTL_YN = #{ESNTL_YN},/* 필수_여부 */
            ENCPT_YN = #{ENCPT_YN},/* 암호화_여부 */
            BSC_VL = #{BSC_VL},/* 기본_값 */
            EXPLN = #{EXPLN},/* 설명 */
            USE_YN = #{USE_YN},/* 사용_여부 */
            SORT_ORD = #{SORT_ORD}::INTEGER, /* 정렬_순서 */
            MDFR_ID = #{USER_ID}::INTEGER,
            MDFCN_DT = TO_CHAR(NOW(),'YYYYMMDDHH24MISS'),
            RSPNS_ARTCL_ID =
            <choose>
                <when test="RSPNS_ARTCL_ID == null or RSPNS_ARTCL_ID ==''">NULL</when>
                <otherwise>#{RSPNS_ARTCL_ID}::INTEGER</otherwise>
            </choose>
            ,
            /* 응답_항목_ID */
            UP_ARTCL_ID =
            <choose>
                <when test="UP_ARTCL_ID == null or UP_ARTCL_ID ==''">NULL</when>
                <otherwise>#{UP_ARTCL_ID}::INTEGER</otherwise>
            </choose>
        /* 상위_파라미터_항목_ID */

        WHERE 1=1
        AND PARAM_ARTCL_ID = #{PARAM_ARTCL_ID}::INTEGER
        AND LKAG_ID = #{LKAG_ID}::INTEGER
    </update>

    <update id="delete" parameterType="java.util.HashMap">
        UPDATE CUSTCO.PLT_LKAG_PARAM_ARTCL SET DEL_YN ='Y' WHERE PARAM_ARTCL_ID = #{PARAM_ARTCL_ID}::INTEGER
    </update>
    <select id="dpcnChk" parameterType="java.util.HashMap" resultType="java.util.HashMap">
        SELECT 1 FROM PLT_LKAG_PARAM_ARTCL
         WHERE LKAG_ID = #{LKAG_ID}::INTEGER
         AND COL_NM = #{COL_NM}
         <if test='id !="-1"'>
            AND PARAM_ARTCL_ID <![CDATA[<>]]> #{id}::INTEGER
         </if>
    </select>
    <update id="UPDATE_OTHER_SORT_ORDER" parameterType="java.util.HashMap">
        UPDATE PLT_LKAG_PARAM_ARTCL /*해당노드(제외) 정렬 순서 변경 (kr.co.hkcloud.palette3.admin.lkag.mng.request.dao.LkagMngRequestMapper.UPDATE_OTHER_SORT_ORDER)*/
        SET MDFCN_DT = TO_CHAR(NOW(), 'YYYYMMDDHH24MISS')
          , MDFR_ID  = #{USER_ID}::INTEGER
          , SORT_ORD = SORT_ORD + (#{ADD_NUM}:: INTEGER)
        WHERE LKAG_ID = #{LKAG_ID}::INTEGER
        <choose>
            <when test="UP_ARTCL_ID !=null and UP_ARTCL_ID != ''">AND UP_ARTCL_ID = #{UP_ARTCL_ID}:: INTEGER</when>
            <otherwise>AND UP_ARTCL_ID IS NULL</otherwise>
        </choose>
        AND SORT_ORD = #{SORT_ORD}::INTEGER
    </update>

    <update id="UPDATE_SORT_ORDER" parameterType="java.util.HashMap">
        UPDATE PLT_LKAG_PARAM_ARTCL /*해당노드(제외) 정렬 순서 변경 (kr.co.hkcloud.palette3.admin.lkag.mng.request.dao.LkagMngRequestMapper.UPDATE_OTHER_SORT_ORDER)*/
        SET MDFCN_DT = TO_CHAR(NOW(), 'YYYYMMDDHH24MISS')
          , MDFR_ID  = #{USER_ID}::INTEGER
          , SORT_ORD = #{SORT_ORD}::INTEGER
        WHERE LKAG_ID = #{LKAG_ID}::INTEGER
        AND PARAM_ARTCL_ID = #{PARAM_ARTCL_ID}::INTEGER
    </update>
</mapper>
