<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.co.hkcloud.palette3.schedule.dao.ScheduleMapper">

    <select id="selectMySchdlStat"  parameterType= "java.util.HashMap" resultType="java.util.HashMap">
        SELECT COALESCE(CNT.MYSCHDL, 0) AS MY_SCHDL /*My 일정 조회  (kr.co.hkcloud.palette3.schedule.dao.ScheduleMapper.selectMyScheduleStat)*/
              , COALESCE(CNT.CTSCHDL, 0) AS CT_SCHDL
              , COALESCE(CNT.MONTHLY + CNT.RLSSCHDL, 0) AS MONTHLY_SCHDL
              , COALESCE(CNT.ESNTLSCHDL, 0) AS ESTNL_SCHDL
        FROM( SELECT
                  SUM(CASE WHEN PS2.USER_ID = #{USER_ID}::INTEGER THEN 1 ELSE 0 END) AS MYSCHDL 								                        	/* 개인일정 */
                   , SUM(CASE WHEN PS2.SCHDL_SE_CD = 'CTSD' THEN 1 ELSE 0 END) AS CTSCHDL		                                        					/* 센터일정 */
                   , SUM(CASE WHEN PS.USER_ID != #{USER_ID}::INTEGER AND PS.RLS_YN = 'Y' AND PS.SCHDL_SE_CD ='PSSD' THEN 1 ELSE 0 END) AS RLSSCHDL 			/* 다른 사용자의 공개일정 */
                   , SUM(CASE WHEN (PS.USER_ID = #{USER_ID}::INTEGER OR PS.SCHDL_SE_CD ='CTSD') THEN 1 ELSE 0 END) AS MONTHLY                           	/* 월간일정 */
                   , SUM(CASE WHEN (PS.USER_ID = #{USER_ID}::INTEGER OR PS.SCHDL_SE_CD ='CTSD') AND PS.ESNTL_YN ='Y' THEN 1 ELSE 0 END) AS ESNTLSCHDL      /* 중요일정 */
              FROM PLT_SCHDL PS
              JOIN PLT_USER_OGNZ PUO ON PUO.USER_ID = PS.USER_ID AND PUO.USE_YN = 'Y'
              LEFT OUTER JOIN (SELECT SCHDL_ID,USER_ID,SCHDL_SE_CD, ESNTL_YN, RLS_YN FROM PLT_SCHDL
                               WHERE (USER_ID = #{USER_ID}::INTEGER OR SCHDL_SE_CD = 'CTSD')
                                 AND SUBSTRING(BGNG_YMD, 1, 10) >= SUBSTRING(TO_CHAR(NOW(),'YYYYMMDDHH24MISS'), 1, 10)
                                 AND SUBSTRING(END_YMD, 1, 6) = SUBSTRING(TO_CHAR(NOW(),'YYYYMMDDHH24MISS'), 1, 6)
                              ) PS2 ON PS.SCHDL_ID = PS2.SCHDL_ID
              WHERE PUO.CUSTCO_ID = #{CUSTCO_ID}::INTEGER
              AND (SUBSTRING(PS.BGNG_YMD, 1, 6) = SUBSTRING(TO_CHAR(NOW(),'YYYYMMDDHH24MISS'), 1, 6)
              AND (SUBSTRING(PS.END_YMD, 1, 6) = SUBSTRING(TO_CHAR(NOW(),'YYYYMMDDHH24MISS'), 1, 6)))
            )CNT
    </select>

    <select id="selectSchedule"  parameterType= "java.util.HashMap" resultType="java.util.HashMap">
    SELECT   PS.SCHDL_ID
             ,PS.USER_ID
             ,PU.USER_NM
             ,PS.SCHDL_SE_CD
             ,PS.BGNG_YMD
             ,PS.END_YMD
             ,PS.PLC
             ,PS.RLS_YN
             ,PS.CN
             ,PS.TTL
             ,PS.ESNTL_YN
             ,PS.REG_DT
        FROM PLT_SCHDL PS
                 LEFT OUTER JOIN PLT_USER PU ON PU.USER_ID = PS.USER_ID
        WHERE PS.USER_ID = #{USER_ID}::INTEGER
    OR PS.RLS_YN = 'Y'
    </select>

    <select id="selectScheduleRtn"  parameterType= "java.util.HashMap" resultType="java.util.HashMap">
        SELECT   PS.SCHDL_ID /*스케줄 목록 조회  (kr.co.hkcloud.palette3.schedule.dao.ScheduleMapper.selectScheduleRtn)*/
             ,PS.USER_ID
             ,PU.USER_NM
             ,PS.SCHDL_SE_CD
             ,PS.BGNG_YMD
             ,PS.END_YMD
             ,PS.PLC
             ,PS.RLS_YN
             ,PS.CN
             ,PS.TTL
             ,PS.ESNTL_YN
             ,PS.REG_DT
        FROM PLT_SCHDL PS
                 LEFT OUTER JOIN PLT_USER PU ON PU.USER_ID = PS.USER_ID
        WHERE PS.USER_ID = #{USER_ID}::INTEGER
 OR PS.RLS_YN = 'Y'
    </select>

    <insert id="insertScheduleRtn"  parameterType= "java.util.HashMap">
<![CDATA[
        INSERT INTO PLT_SCHDL       /* 스케줄 등록  (kr.co.hkcloud.palette3.schedule.dao.ScheduleMapper.insertScheduleRtn)*/
        (
            SCHDL_ID							/*  스케쥴 아이디  */
        ,USER_ID							/*  유저 아이디    */
        ,SCHDL_SE_CD						/*  일정 구분 코드 */
        ,TTL								/*  제목             */
        ,ESNTL_YN							/*  중요 여부       */
        ,BGNG_YMD							/*  시작 일자       */
        ,END_YMD							/*  종료 일자       */
        ,PLC								/*  장소             */
        ,RLS_YN								/*  공개 여부       */
        ,CN									/*  내용             */
        ,REG_DT       						/*  등록 날짜       */
        )
        VALUES (
                   #{SCHDL_ID}::INTEGER
               ,#{USER_ID}::INTEGER
               ,#{SCHDL_SE_CD}
               ,#{TTL}
               ,#{ESNTL_YN}
               ,#{BGNG_YMD}
               ,#{END_YMD}
               ,#{PLC}
               ,#{RLS_YN}
               ,#{CN}
               ,TO_CHAR(NOW(),'YYYYMMDDHH24MISS')
               )
        ]]>
</insert>

    <update id="updateScheduleRtn"  parameterType= "java.util.HashMap">
        UPDATE PLT_SCHDL                 /* 스케줄 수정ㅍ  (kr.co.hkcloud.palette3.schedule.dao.ScheduleMapper.updateScheduleRtn)*/
        SET REG_DT =  TO_CHAR(NOW(),'YYYYMMDDHH24MISS') 						/*  등록 날짜       */
        <if test="SCHDL_SE_CD    	!= '' and	SCHDL_SE_CD  != null"> ,SCHDL_SE_CD = #{SCHDL_SE_CD}  </if> /* 스케줄 구분 */
        <if test="TTL    			!= '' and	TTL   	 	 != null"> ,TTL = #{TTL}  				  </if> /* 제목          */
        <if test="ESNTL_YN    		!= '' and	ESNTL_YN   	 != null"> ,ESNTL_YN = #{ESNTL_YN}  	  </if> /*  중요 여부       */
        <if test="BGNG_YMD    		!= '' and	BGNG_YMD   	 != null"> ,BGNG_YMD = #{BGNG_YMD}  	  </if> /*  시작 일자       */
        <if test="END_YMD    		!= '' and	END_YMD   	 != null"> ,END_YMD = #{END_YMD}  		  </if> /*  종료 일자       */
        <if test="RLS_YN    			!= '' and	RLS_YN   	 != null"> ,RLS_YN = #{RLS_YN}  		  </if> /*  공개 여부   */
        <if test="PLC    			!= '' and	PLC   	 != null"> ,PLC = #{PLC}  		  </if> /*  장소   */
        <if test="CN    				!= '' and	CN   		 != null"> 				,CN = #{CN}  	  </if> /*  내용       */
        WHERE USER_ID = #{USER_ID}::INTEGER
        AND SCHDL_ID	= #{SCHDL_ID}::INTEGER
    </update>
    <delete id="deleteScheduleRtn"  parameterType= "java.util.HashMap">
<![CDATA[            /* 스케줄 삭제  (kr.co.hkcloud.palette3.schedule.dao.ScheduleMapper.deleteScheduleRtn)*/
        DELETE FROM PLT_SCHDL
        WHERE USER_ID = #{USER_ID}::INTEGER
   AND SCHDL_ID = #{SCHDL_ID}::INTEGER
        ]]>
</delete>


</mapper>

